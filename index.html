<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Game Life â­</title>
<style>
:root{
  --bg:#0b0f14;--bg2:#0f1520;--card:#121826;--text:#e6edf3;--muted:#9fb3c8;
  --line:rgba(255,255,255,.12);--grad:linear-gradient(90deg,#6ee7ff,#a78bfa);
  --danger:#ff6b6b;--warning:#ffa726;--ok:#4ade80
}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text)}
.top{position:fixed;inset:0 0 auto 0;z-index:10;background:rgba(11,15,20,.95);
  backdrop-filter:blur(12px);border-bottom:1px solid var(--line);transition:transform .3s}
.top.hidden{transform:translateY(-100%)} .container{width:min(1100px,94vw);margin:0 auto;padding:70px 0 40px}
.header-content{display:flex;align-items:center;justify-content:space-between;padding:8px}
.title{flex:1;text-align:center} .title h1{margin:0;font-size:1.2rem} .title p{margin:0;font-size:.75rem}
.muted{color:var(--muted)}
.menu-toggle,.back-btn-header,button{border:1px solid var(--line);background:#0d1520;color:var(--text);cursor:pointer}
.menu-toggle,.back-btn-header{border:none;font-size:1rem;padding:8px;border-radius:8px}
.menu-toggle{font-size:1.5rem} .menu-toggle:hover,.back-btn-header:hover{background:rgba(255,255,255,.1)}
.mobile-menu{position:absolute;top:100%;left:0;right:0;background:rgba(11,15,20,.98);
  backdrop-filter:blur(12px);border-bottom:1px solid var(--line);display:none;flex-direction:column;gap:4px;padding:8px}
.mobile-menu.show{display:flex} .tab{padding:.5rem .8rem;border-radius:8px;border:1px solid var(--line);background:#0d1520;
  color:var(--text);font-size:.9rem;text-align:left;width:100%} .tab.active{border-color:rgba(255,255,255,.35)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px;
  transition:transform .2s,box-shadow .2s}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(110,231,255,.1)}
.player{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;flex-wrap:wrap}
.row{display:flex;justify-content:space-between;gap:8px;align-items:center}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)} .half{grid-column:span 12}
@media(min-width:860px){.half{grid-column:span 6}}
.kpis{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.kpi{grid-column:span 12;background:#0f1726;border:1px solid var(--line);border-radius:12px;padding:12px;cursor:pointer}
@media(min-width:860px){.kpi{grid-column:span 6}} .kpi:hover{border-color:rgba(255,255,255,.25)}
.kpi.malus{background:#2a1a1a;border-color:#8b3a3a}
input[type="number"],input[type="text"],input[type="date"]{padding:.45rem;border-radius:10px;border:1px solid var(--line);
  background:#0c121a;color:var(--text);text-align:center;min-width:90px}
input[disabled],select[disabled],button[disabled]{opacity:.55;cursor:not-allowed}
select{padding:.45rem;border-radius:10px;border:1px solid var(--line);background:#0c121a;color:var(--text)}
.bar,.gbar{height:12px;border-radius:999px;background:#0e1622;border:1px solid var(--line);overflow:hidden}
.bar>span,.gfill{display:block;height:100%;background:var(--grad);width:0%}
.chip{background:#0e1622;border:1px solid var(--line);border-radius:999px;padding:.3rem .6rem;color:var(--muted);font-size:.9rem}
button{padding:.55rem .85rem;border-radius:10px} button.ghost{opacity:.85} button.danger{background:#4a1e1e;border-color:#8b3a3a}
button.warning{background:#5a3a1e;border-color:#8b6a3a} button.ok{background:#153a2a;border-color:#2d8a5a}
.badge{display:inline-flex;align-items:center;gap:6px;padding:.3rem .6rem;border-radius:999px;background:#142033;border:1px solid var(--line);color:#cde3ff}
.badge i{font-style:normal;background:#1a2a44;padding:2px 6px;border-radius:6px}
.view{display:none} .view.active{display:block} .hidden{display:none !important}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;z-index:100;align-items:center;justify-content:center}
.modal.active{display:flex} .modal-content{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px;width:min(520px,92vw);max-height:80vh;overflow:auto}
.form-group{margin-bottom:12px} .form-group label{display:block;margin-bottom:6px}
.task-item{background:#0e1622;border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:8px}
.manage-item{background:#0e1622;border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;gap:12px;align-items:center}
.manage-item-actions{display:flex;gap:8px}
.malus-item{background:#2a1a1a;border:1px solid #8b3a3a;border-radius:8px;padding:12px;margin-bottom:8px}
.malus-active{background:#4a1e1e;border-color:#ff6b6b}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
.stat-card{background:#0e1622;border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center}
#toast{position:fixed;right:14px;bottom:14px;padding:12px 16px;background:#0f1726;border:1px solid var(--line);
  border-radius:10px;opacity:0;transform:translateY(20px);transition:.3s;z-index:1000}
#toast.show{opacity:1;transform:translateY(0)} #toast.success{background:#1a4a3a;border-color:#2d8a5a;color:var(--ok)}
#toast.error{background:#4a1e1e;border-color:#8b3a3a;color:#f87171} #toast.info{background:#1e3a8a;border-color:#3b82f6;color:#60a5fa}
#toast.warning{background:#5a3a1e;border-color:#8b6a3a;color:#ffa726}
.xp-gain,.xp-loss{position:fixed;font-weight:bold;pointer-events:none;animation:xpFloat 2s ease-out forwards;z-index:1001}
.xp-gain{color:#fbbf24} .xp-loss{color:#ff6b6b}
@keyframes xpFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
.level-up{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--grad);color:#000;padding:20px 40px;border-radius:20px;font-size:1.5rem;font-weight:bold;z-index:1002;animation:levelUpPulse 3s ease-out forwards}
@keyframes levelUpPulse{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}40%{transform:translate(-50%,-50%) scale(1)}100%{opacity:0}}
/* sections spÃ©cifiques */
.two-col{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:920px){.two-col{grid-template-columns:1fr 1fr}}
.goal-list li{display:flex;justify-content:space-between;border-bottom:1px solid var(--line);padding:6px 0}
.small{font-size:.85rem}
</style>
</head>
<body>
<header class="top">
  <div class="header-content">
    <button id="backButton" class="back-btn-header" style="display:none">â† Retour</button>
    <div class="title">
      <h1>â­ Game Life</h1>
      <p class="muted">c'est toi qui choisis de stagner ou d'Ã©voluer</p>
    </div>
    <div class="row">
      <button id="toggleEdit" class="ghost">âœï¸ Modifier (OFF)</button>
      <button id="undoBtn" class="ghost" title="Annuler derniÃ¨re action">â†©ï¸ Annuler</button>
      <button id="menuToggle" class="menu-toggle">â˜°</button>
    </div>
  </div>
  <nav id="mobileMenu" class="mobile-menu">
    <button class="tab active" data-goto="goals">ğŸ¯ Objectifs</button>
    <button class="tab" data-goto="tasks">âœ… TÃ¢ches</button>
    <button class="tab" data-goto="rewards">ğŸ RÃ©compenses</button>
    <button class="tab" data-goto="malus">âš ï¸ Malus</button>
    <button class="tab" data-goto="bonus">âœ¨ Bonus</button>
    <button class="tab" data-goto="stats">ğŸ“Š Statistiques</button>
    <button id="exportData" class="ghost">ğŸ“¤ Exporter</button>
  </nav>
</header>

<main class="container">
  <!-- PLAYER / Accueil -->
  <section class="card">
    <div class="player">
      <div style="min-width:280px">
        <h2>
          <span id="player_title_prefix">ğŸ®</span>
          <span id="player_title_name">Joueur</span>
          <span class="badge"><i>Lvl</i><b id="level">1</b></span>
        </h2>

        <div class="row small" style="margin:6px 0 4px">
          <label class="muted">Pseudo :</label>
          <input id="player_name" type="text" placeholder="Ton nom" style="width:180px">
        </div>

        <div class="row small" style="gap:8px;flex-wrap:wrap;margin:6px 0">
          <label class="muted">Jour :</label>
          <input id="selected_date" type="date" />
          <span class="chip">ValidÃ© : <b id="date_validated">non</b></span>
        </div>

        <div class="row"><strong>XP</strong><span id="xp_text">0 / 100</span></div>
        <div class="gbar"><span id="xp_bar" class="gfill" style="width:0%"></span></div>

        <div style="margin-top:8px">
          <span class="chip">ğŸ•Œ Streak priÃ¨res: <b id="streak_pr">0</b> j</span>
          <span class="chip">ğŸš« Malus actifs: <b id="active_malus">0</b></span>
        </div>
      </div>

      <div class="row" style="gap:8px">
        <button id="validateDay">Valider la journÃ©e</button>
        <button id="checkMalus" class="warning">AperÃ§u malus</button>
        <button id="applyMalus" class="danger">Appliquer malus</button>
        <button id="importData" class="ghost">ğŸ“¥ Importer</button>
        <button id="resetAll" class="ghost">ğŸ”„ Reset</button>
      </div>
    </div>
  </section>

  <!-- ARGENT semaine / mois -->
  <section class="card">
    <h2>ğŸ’° Objectifs argent</h2>
    <div class="grid">
      <div class="half card">
        <div class="row"><b>Semaine</b>
          <span class="small">
            Fait: <b id="money_week_done">0</b> / Objectif:
            <input id="money_week_target" type="number" min="0" step="1" data-editable>
          </span>
        </div>
        <div class="row small">
          <span>Reste</span><b id="money_week_left">0</b>
        </div>
      </div>
      <div class="half card">
        <div class="row"><b>Mois</b>
          <span class="small">
            Fait: <b id="money_month_done">0</b> / Objectif:
            <input id="money_month_target" type="number" min="0" step="1" data-editable>
          </span>
        </div>
        <div class="row small">
          <span>Reste</span><b id="money_month_left">0</b>
        </div>
      </div>
    </div>
  </section>

  <!-- Mini jauges secteurs -->
  <section class="card">
    <h2>ğŸ“ˆ Progression hebdo par secteur</h2>
    <div id="sector_gauges" class="grid" style="margin-top:8px">
      <div class="half card"><div class="row"><b>ğŸ’¸ Business</b><span id="g_biz_txt">0/100</span></div><div class="gbar"><span id="g_biz" class="gfill"></span></div></div>
      <div class="half card"><div class="row"><b>ğŸ¥ UGC</b><span id="g_ugc_txt">0/100</span></div><div class="gbar"><span id="g_ugc" class="gfill"></span></div></div>
      <div class="half card"><div class="row"><b>ğŸ‹ï¸ Sport</b><span id="g_sport_txt">0/60</span></div><div class="gbar"><span id="g_sport" class="gfill"></span></div></div>
      <div class="half card"><div class="row"><b>ğŸ“š DÃ©v perso</b><span id="g_dev_txt">0/50</span></div><div class="gbar"><span id="g_dev" class="gfill"></span></div></div>
      <div class="half card"><div class="row"><b>ğŸ•Œ SpiritualitÃ©</b><span id="g_spi_txt">0/60</span></div><div class="gbar"><span id="g_spi" class="gfill"></span></div></div>
    </div>
  </section>

  <!-- Objectifs proches / lointains -->
  <section class="card">
    <h2>ğŸ§­ PrioritÃ©s</h2>
    <div class="two-col">
      <div class="card">
        <h3>ğŸŸ© 5 objectifs les plus proches</h3>
        <ul id="goals_closest" class="goal-list"></ul>
      </div>
      <div class="card">
        <h3>ğŸŸ¥ 5 objectifs les plus loin</h3>
        <ul id="goals_farthest" class="goal-list"></ul>
      </div>
    </div>
  </section>

  <!-- GOALS -->
  <section id="view-goals" class="view active">
    <section class="card">
      <h2>ğŸ¯ Objectifs (hebdo) <span class="small muted">(modifiables en mode Ã©dition)</span></h2>
      <div id="kpis" class="kpis"></div>
    </section>
  </section>

  <!-- TASKS (par catÃ©gorie) -->
  <section id="view-tasks" class="view">
    <section class="card">
      <h2>âœ… TÃ¢ches (par catÃ©gorie)</h2>
      <div id="tasks_by_cat" class="grid"></div>

      <div class="category-actions">
        <button id="manageDailyTasks" class="ghost hidden">âœï¸ GÃ©rer Quotidiennes</button>
        <button id="manageWeeklyTasks" class="ghost hidden">âœï¸ GÃ©rer Hebdo</button>
        <button id="manageMonthlyTasks" class="ghost hidden">âœï¸ GÃ©rer Mensuelles</button>
        <button id="resetDaily" class="ghost">RÃ©initialiser la journÃ©e</button>
        <button id="resetWeekly" class="ghost">RÃ©initialiser la semaine</button>
        <button id="resetMonthly" class="ghost">RÃ©initialiser le mois</button>
      </div>
    </section>
  </section>

  <!-- REWARDS -->
  <section id="view-rewards" class="view">
    <section class="card">
      <h2>ğŸ RÃ©compenses</h2>
      <div id="rewards_list" class="grid"></div>
      <div class="category-actions">
        <button id="manageRewards" class="ghost hidden">âœï¸ GÃ©rer les rÃ©compenses</button>
      </div>
    </section>
    <section class="card">
      <h2>Historique</h2>
      <ul id="rewards_log" class="muted"></ul>
    </section>
  </section>

  <!-- MALUS -->
  <section id="view-malus" class="view">
    <section class="card">
      <h2>âš ï¸ Malus & RÃ¨gles</h2>
      <div class="grid">
        <div class="half card">
          <h3>RÃ¨gles (Ã©diter en mode Ã©dition)</h3>
          <div class="form-group small">
            <label>XP min / jour</label>
            <input id="rule_day_min" type="number" step="1" min="0" data-editable>
          </div>
          <div class="form-group small">
            <label>XP min / semaine</label>
            <input id="rule_week_min" type="number" step="1" min="0" data-editable>
          </div>
          <div class="form-group small">
            <label>XP Business min / semaine</label>
            <input id="rule_biz_min" type="number" step="1" min="0" data-editable>
          </div>
          <div class="form-group small">
            <label>Lectures min / semaine</label>
            <input id="rule_read_min" type="number" step="1" min="0" data-editable>
          </div>
        </div>
        <div class="half card">
          <h3>AperÃ§u</h3>
          <div id="malus_preview"></div>
          <div class="row" style="gap:8px;margin-top:8px">
            <button id="btnPreviewMalus" class="ghost">ğŸ” Calculer aperÃ§u</button>
            <button id="applyMalus2" class="danger">ğŸš¨ Appliquer maintenant</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Malus/PÃ©nalitÃ©s actifs</h3>
        <div id="malus_status"></div>
      </div>
    </section>
  </section>

  <!-- BONUS -->
  <section id="view-bonus" class="view">
    <section class="card">
      <h2>âœ¨ Bonus (exploits)</h2>
      <div id="bonus_list"></div>
      <div class="category-actions">
        <button id="addBonus" class="ghost hidden">+ Ajouter un bonus</button>
      </div>
    </section>
  </section>

  <!-- STATS -->
  <section id="view-stats" class="view">
    <section class="card">
      <h2>ğŸ“Š Statistiques</h2>
      <div id="stats_content"></div>
    </section>
  </section>
</main>

<!-- Modales gÃ©nÃ©riques -->
<div id="taskModal" class="modal"><div class="modal-content">
  <h2 id="taskModalTitle">GÃ©rer les tÃ¢ches</h2>
  <div id="taskManageList"></div>
  <div class="category-actions">
    <button id="addNewTask" class="ghost">+ Ajouter</button>
    <button id="closeTaskModal">Fermer</button>
  </div>
</div></div>

<div id="rewardModal" class="modal"><div class="modal-content">
  <h2>GÃ©rer les rÃ©compenses</h2>
  <div id="rewardManageList"></div>
  <div class="category-actions">
    <button id="addNewReward" class="ghost">+ Ajouter</button>
    <button id="closeRewardModal">Fermer</button>
  </div>
</div></div>

<div id="editModal" class="modal"><div class="modal-content">
  <h2 id="editModalTitle">Modifier</h2>
  <form id="editForm">
    <div class="form-group"><label for="editName">Nom :</label><input type="text" id="editName" required></div>
    <div class="form-group"><label for="editValue">Valeur :</label><input type="number" id="editValue" required></div>
    <div class="form-group" id="editCategoryGroup">
      <label for="editCategory">CatÃ©gorie :</label>
      <select id="editCategory">
        <option value="discipline">Discipline</option>
        <option value="business">Business</option>
        <option value="ugc">UGC</option>
        <option value="sport">Sport</option>
        <option value="social">Social</option>
        <option value="dev">DÃ©veloppement</option>
        <option value="spirituality">SpiritualitÃ©</option>
      </select>
    </div>
    <div class="form-group" id="editTagGroup">
      <label for="editTag">Tag :</label><input type="text" id="editTag">
    </div>
    <div class="category-actions">
      <button type="submit">Sauvegarder</button>
      <button type="button" id="cancelEdit">Annuler</button>
    </div>
  </form>
</div></div>

<div id="toast"></div>

<script>
/* ================== STATE / STORAGE ================== */
const KEY="gamelife_v3";
function dflt(){
  return {
    edit:false,
    profile:{name:"",level:1,xp:0,streaks:{prayer:0},stats:{dailyXP:0,weeklyXP:0,monthlyXP:0}},
    money:{week:{target:0,done:0},month:{target:0,done:0}},
    goals:{
      discipline:{label:"â° Discipline/RÃ©veil",bars:[
        {id:"wake_early",label:"RÃ©veils avant 8h",now:0,goal:7},
        {id:"wake_very_early",label:"RÃ©veils avant 7h",now:0,goal:3},
        {id:"wake_extreme",label:"RÃ©veils avant 6h",now:0,goal:1}
      ]},
      business:{label:"ğŸ’¸ Business MLM",bars:[
        {id:"mlm_prospects",label:"Prospections MLM",now:0,goal:140},
        {id:"mlm_presentations",label:"PrÃ©sentations",now:0,goal:7},
        {id:"mlm_inscriptions",label:"Inscriptions",now:0,goal:1}
      ]},
      ugc:{label:"ğŸ¥ UGC",bars:[
        {id:"ugc_prospects",label:"Prospections marques",now:0,goal:140},
        {id:"ugc_collabs",label:"Collabs signÃ©es",now:0,goal:1}
      ]},
      sport:{label:"ğŸ‹ï¸ Sport",bars:[
        {id:"workouts",label:"Workouts",now:0,goal:5},
        {id:"runs",label:"Courses",now:0,goal:3}
      ]},
      social:{label:"ğŸ“± RÃ©seaux sociaux",bars:[
        {id:"reels",label:"Reels postÃ©s",now:0,goal:5},
        {id:"videos",label:"VidÃ©os produites",now:0,goal:6}
      ]},
      dev:{label:"ğŸ“š DÃ©veloppement perso",bars:[
        {id:"lectures",label:"Lectures (20min)",now:0,goal:5},
        {id:"introspections",label:"Introspections",now:0,goal:5}
      ]},
      spirituality:{label:"ğŸ•Œ SpiritualitÃ©",bars:[
        {id:"daily_prayers",label:"JournÃ©es 5 priÃ¨res",now:0,goal:7},
        {id:"jumuah",label:"Jumu'ah",now:0,goal:1}
      ]}
    },
    tasks:{
      daily:[
        {id:"wake_early",label:"RÃ©veil avant 8h",xp:10,done:false,category:"discipline"},
        {id:"wake_very_early",label:"RÃ©veil avant 7h",xp:20,done:false,category:"discipline"},
        {id:"wake_extreme",label:"RÃ©veil avant 6h",xp:30,done:false,category:"discipline"},
        {id:"prayers_5",label:"5 priÃ¨res du jour",xp:25,done:false,category:"spirituality"},
        {id:"mlm_prospect_20",label:"20 prospections MLM",xp:22,done:false,category:"business"},
        {id:"ugc_prospect_20",label:"20 prospections UGC",xp:22,done:false,category:"ugc"},
        {id:"workout",label:"1 workout",xp:10,done:false,category:"sport"},
        {id:"run",label:"1 course",xp:12,done:false,category:"sport"},
        {id:"reel",label:"1 reel postÃ©",xp:8,done:false,category:"social"},
        {id:"video",label:"1 vidÃ©o produite",xp:5,done:false,category:"social"},
        {id:"lecture",label:"Lecture 20min",xp:8,done:false,category:"dev"},
        {id:"introspection",label:"Introspection courte",xp:8,done:false,category:"dev"}
      ],
      weekly:[
        {id:"jumuah",label:"Jumu'ah",xp:30,done:false,category:"spirituality"},
        {id:"big_introspection",label:"Grosse introspection",xp:30,done:false,category:"dev"},
        {id:"mlm_presentation",label:"PrÃ©sentation MLM",xp:5,done:false,category:"business"},
        {id:"ugc_collab",label:"Collab UGC signÃ©e",xp:50,done:false,category:"ugc"}
      ],
      monthly:[]
    },
    rewards:{
      catalog:[
        {id:"film",name:"Film/Ã©pisode (1h30)",cost:100,tag:"DÃ©tente"},
        {id:"activity",name:"ActivitÃ© plaisir (1-2h)",cost:150,tag:"Plaisir"},
        {id:"friends",name:"SoirÃ©e amis/famille",cost:200,tag:"Social"},
        {id:"spa",name:"Spa/dÃ©tente (2h)",cost:250,tag:"Bien-Ãªtre"},
        {id:"shopping",name:"Shopping â‰¤50 CHF",cost:300,tag:"Shopping"},
        {id:"day_off",name:"Day off complet",cost:300,tag:"Repos"},
        {id:"weekend",name:"Weekend dÃ©tente",cost:800,tag:"Voyage"}
      ],
      inventory:{},  // {id: count}
      log:[]
    },
    malus:{
      rules:{dayMin:100,weekMin:250,bizMin:100,readMin:3},
      active:[],
      penalties:[]
    },
    bonus:[  // exploits custom
      // {id:'b1',name:'1k abonnÃ©s',xp:100,claimed:false}
    ],
    byDate:{}, // 'YYYY-MM-DD': { dailyDone:{id:true}, dailyXP:number, validated:boolean }
    _history:[]
  };
}
let state=load();
function load(){try{return JSON.parse(localStorage.getItem(KEY))||dflt()}catch(e){return dflt()}}
function save(){localStorage.setItem(KEY,JSON.stringify(state))}
function pushHistory(){state._history=state._history||[];state._history.push(JSON.stringify(state))}
function undo(){if(!state._history||!state._history.length){toast("Rien Ã  annuler","info");return}
  const snap=state._history.pop();try{state=JSON.parse(snap)}catch(e){return} save(); init(); toast("Action annulÃ©e","info")}
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

/* =============== UI Helpers =============== */
function toast(t,typ="info"){const el=$("#toast");el.textContent=t;el.className=typ;el.classList.add("show");
  setTimeout(()=>{el.classList.remove("show");setTimeout(()=>el.className="",300)},2500)}
function xpNeed(l){return 50+l*50}
function showXPGain(amount,el){const n=document.createElement("div");n.className=amount>0?'xp-gain':'xp-loss';
  n.textContent=(amount>0?'+':'')+amount+' XP';const r=el.getBoundingClientRect();n.style.left=(r.left+r.width/2)+'px';n.style.top=r.top+'px';
  document.body.appendChild(n);setTimeout(()=>n.remove(),2000)}
function showLevelUp(level){const el=document.createElement("div");el.className='level-up';el.textContent=`ğŸ‰ NIVEAU ${level} ! ğŸ‰`;
  document.body.appendChild(el);setTimeout(()=>el.remove(),3000)}
function todayISO(d=new Date()){return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10)}
let currentDate=todayISO();

/* ====== EDIT MODE ====== */
function applyEditModeUI(){
  const on=!!state.edit;
  $("#toggleEdit").textContent = on? "âœï¸ Modifier (ON)" : "âœï¸ Modifier (OFF)";
  // inputs marquÃ©s data-editable
  $$('[data-editable], input[type="number"], input[type="text"], select').forEach(i=>{
    if(i.hasAttribute('data-editable')) i.disabled=!on;
  });
  // boutons de gestion
  ["manageDailyTasks","manageWeeklyTasks","manageMonthlyTasks","manageRewards","addBonus"]
    .forEach(id=>{const b=$("#"+id); if(!b) return; b.classList.toggle("hidden",!on)});
  // les inputs objectifs (now/goal)
  $$('#kpis input[type="number"]').forEach(i=>i.disabled=!on);
}
$("#toggleEdit").onclick=()=>{state.edit=!state.edit; save(); applyEditModeUI(); toast(state.edit?"Mode Ã©dition ON":"Mode Ã©dition OFF","info")};
$("#undoBtn").onclick=()=>undo();

/* =============== Header / Nav =============== */
$("#menuToggle").onclick=()=>$("#mobileMenu").classList.toggle("show");
document.addEventListener("click",(e)=>{
  const m=$("#mobileMenu"),t=$("#menuToggle"); if(!m.contains(e.target)&&!t.contains(e.target)) m.classList.remove("show");
});
$$(".tab").forEach(b=>b.addEventListener("click",()=>{
  $$(".tab").forEach(t=>t.classList.remove("active")); b.classList.add("active");
  $$(".view").forEach(v=>v.classList.remove("active")); $("#view-"+b.dataset.goto).classList.add("active");
  $("#mobileMenu").classList.remove("show");
  $("#backButton").style.display=b.dataset.goto==="goals"?"none":"block";
}));
$("#backButton").onclick=()=>{
  $$(".view").forEach(v=>v.classList.remove("active")); $("#view-goals").classList.add("active");
  $$(".tab").forEach(t=>t.classList.remove("active")); $('.tab[data-goto="goals"]').classList.add("active"); $("#backButton").style.display="none";
};

/* =============== XP / Profile =============== */
function updateXP(){
  const need=xpNeed(state.profile.level); const xp=Math.max(0,state.profile.xp||0);
  $("#xp_text").textContent=`${xp} / ${need}`; $("#xp_bar").style.width=Math.min(100,Math.round(xp/need*100))+"%";
  $("#level").textContent=state.profile.level;
}
function addXP(x,srcEl=null){
  pushHistory();
  state.profile.xp=Math.max(0,(state.profile.xp||0)+x);
  state.profile.stats.dailyXP+=x; state.profile.stats.weeklyXP+=x; state.profile.stats.monthlyXP+=x;
  if(srcEl) showXPGain(x,srcEl);
  while(state.profile.xp>=xpNeed(state.profile.level)){state.profile.xp-=xpNeed(state.profile.level); state.profile.level++; showLevelUp(state.profile.level)}
  save(); updateXP(); updateStreaks();
}
function updateStreaks(){
  $("#streak_pr").textContent=state.profile.streaks.prayer||0;
  $("#active_malus").textContent=state.malus.active.length||0;
}
const nameEl=$("#player_name");
nameEl.oninput=()=>{state.profile.name=nameEl.value; save(); drawPlayerName()};
function drawPlayerName(){
  $("#player_title_name").textContent= state.profile.name? state.profile.name : "Joueur";
}

/* =============== Argent (semaine/mois) =============== */
function renderMoney(){
  $("#money_week_target").value = state.money.week.target||0;
  $("#money_month_target").value = state.money.month.target||0;
  $("#money_week_done").textContent = state.money.week.done||0;
  $("#money_month_done").textContent = state.money.month.done||0;
  $("#money_week_left").textContent = Math.max(0,(state.money.week.target||0)-(state.money.week.done||0));
  $("#money_month_left").textContent = Math.max(0,(state.money.month.target||0)-(state.money.month.done||0));
}
$("#money_week_target").oninput=()=>{if(!state.edit) return; pushHistory(); state.money.week.target=+$("#money_week_target").value||0; save(); renderMoney()};
$("#money_month_target").oninput=()=>{if(!state.edit) return; pushHistory(); state.money.month.target=+$("#money_month_target").value||0; save(); renderMoney()};

/* =============== Objectifs (KPIs) =============== */
function pct(n,g){n=Math.max(0,+n||0); g=Math.max(0,+g||0); return g?Math.min(100,Math.round(n/g*100)):0}
function renderKPIs(){
  const wrap=$("#kpis"); wrap.innerHTML="";
  for(const [key,cat] of Object.entries(state.goals)){
    const card=document.createElement("div"); card.className="kpi"; card.dataset.cat=key;
    let html=`<h3>${cat.label}</h3>`;
    cat.bars.forEach(b=>{
      const p=pct(b.now,b.goal);
      html+=`<div class="row"><strong>${b.label}</strong>
        <span>
          <input data-editable id="${b.id}_now" type="number" value="${b.now}" min="0" ${state.edit?"":"disabled"}>
          /
          <input data-editable id="${b.id}_goal" type="number" value="${b.goal}" min="0" ${state.edit?"":"disabled"}>
        </span></div>
        <div class="bar"><span id="${b.id}_bar" style="width:${p}%"></span></div>`;
    });
    card.innerHTML=html; wrap.appendChild(card);
  }
  // Bindings
  for(const cat of Object.values(state.goals)){
    cat.bars.forEach(b=>{
      const now=$("#"+b.id+"_now"), goal=$("#"+b.id+"_goal"), bar=$("#"+b.id+"_bar");
      const recalc=()=>{ if(!state.edit) return;
        pushHistory(); b.now=+now.value||0; b.goal=+goal.value||0; bar.style.width=pct(b.now,b.goal)+'%'; save();
        renderPriorities();
      };
      now.oninput=recalc; goal.oninput=recalc;
    });
  }
}

/* =============== PrioritÃ©s (plus proche / plus loin) =============== */
function allGoalBars(){
  const list=[];
  for(const [ck,cat] of Object.entries(state.goals)){
    cat.bars.forEach(b=>{
      const remaining=Math.max(0,(b.goal||0)-(b.now||0));
      list.push({cat:cat.label,id:b.id,label:b.label,now:b.now,goal:b.goal,remaining});
    });
  }
  return list;
}
function renderPriorities(){
  const bars=allGoalBars().filter(b=>b.goal>0);
  const sorted=[...bars].sort((a,b)=>a.remaining-b.remaining);
  const closest=sorted.slice(0,5), farthest=[...bars].sort((a,b)=>b.remaining-a.remaining).slice(0,5);
  $("#goals_closest").innerHTML=closest.map(x=>`<li><span>${x.label}</span><b>${x.now}/${x.goal} (reste ${x.remaining})</b></li>`).join("");
  $("#goals_farthest").innerHTML=farthest.map(x=>`<li><span>${x.label}</span><b>${x.now}/${x.goal} (reste ${x.remaining})</b></li>`).join("");
}

/* =============== TÃ‚CHES (par catÃ©gorie) =============== */
function tasksGroupedByCategory(){
  const map={}; const push=(t,scope)=>{(map[t.category]=map[t.category]||[]).push({...t,_scope:scope})};
  state.tasks.daily.forEach(t=>push(t,'daily'));
  state.tasks.weekly.forEach(t=>push(t,'weekly'));
  state.tasks.monthly.forEach(t=>push(t,'monthly'));
  return map;
}
function renderTasksByCategory(){
  const mount=$("#tasks_by_cat"); mount.innerHTML="";
  const groups=tasksGroupedByCategory();
  Object.entries(groups).forEach(([cat,items])=>{
    const box=document.createElement("div"); box.className="half card";
    let html=`<h3>${cat.toUpperCase()}</h3>`;
    items.forEach(t=>{
      const scopeChip = t._scope==='daily'?'ğŸ—“ï¸Q':'ğŸ—“ï¸H' && t._scope==='weekly'?'ğŸ—“ï¸H':(t._scope==='monthly'?'ğŸ—“ï¸M':'');
      html+=`<div class="row"><label>
        <input type="checkbox" data-scope="${t._scope}" data-id="${t.id}" ${t.done?'checked':''}>
        ${t.label} <span class="muted small">${scopeChip}</span></label>
        <span class="muted">+${t.xp} XP</span></div>`;
    });
    box.innerHTML=html; mount.appendChild(box);
  });
}
document.addEventListener("change",(e)=>{
  const el=e.target; if(!el.matches('input[type="checkbox"][data-scope]')) return;
  const scope=el.getAttribute("data-scope"), id=el.getAttribute("data-id");
  const list=scope==="daily"?state.tasks.daily:scope==="weekly"?state.tasks.weekly:state.tasks.monthly;
  const t=list.find(x=>x.id===id); if(!t) return;

  pushHistory();
  const was=t.done; t.done=el.checked;

  // rÃ¨gles spÃ©ciales qui mettent Ã  jour les objectifs correspondants
  if(t.id==="prayers_5" && t.done && !was){ state.profile.streaks.prayer++; updateGoalFromTask("daily_prayers"); }
  if(t.id==="mlm_prospect_20" && t.done && !was){ updateGoalFromTask("mlm_prospects",20) }
  if(t.id==="ugc_prospect_20" && t.done && !was){ updateGoalFromTask("ugc_prospects",20) }

  const map={ "workout":"workouts","run":"runs","reel":"reels","video":"videos",
    "lecture":"lectures","introspection":"introspections","jumuah":"jumuah",
    "mlm_presentation":"mlm_presentations","ugc_collab":"ugc_collabs",
    "wake_early":"wake_early","wake_very_early":"wake_very_early","wake_extreme":"wake_extreme"
  };
  if(map[t.id] && t.done && !was) updateGoalFromTask(map[t.id]);

  addXP(t.done? t.xp : -t.xp, el.closest('.row')||el);
  saveDay(currentDate); save(); renderKPIs(); renderPriorities(); renderSectorGauges();
});
function updateGoalFromTask(goalId,amount=1){
  for(const cat of Object.values(state.goals)){ const bar=cat.bars.find(b=>b.id===goalId); if(bar){bar.now+=amount;break} }
}

/* =============== Stockage par date (quotidien) =============== */
function loadDay(date){
  const day=state.byDate[date]||{dailyDone:{},dailyXP:0,validated:false};
  state.tasks.daily.forEach(t=>{ t.done=!!day.dailyDone[t.id] });
  $("#date_validated").textContent = day.validated? "oui" : "non";
  renderTasksByCategory();
}
function saveDay(date){
  const day=state.byDate[date]||{dailyDone:{},dailyXP:0,validated:false};
  state.tasks.daily.forEach(t=>day.dailyDone[t.id]=!!t.done);
  day.dailyXP = state.tasks.daily.filter(t=>t.done).reduce((s,t)=>s+t.xp,0);
  state.byDate[date]=day; save();
}
const dEl=$("#selected_date"); dEl.value=currentDate;
dEl.onchange=(e)=>{currentDate=e.target.value||todayISO(); loadDay(currentDate)};

$("#validateDay").onclick=()=>{ // valide le jour affichÃ© + bonus hebdo usuels
  pushHistory();
  // Bonus divers dÃ©jÃ  prÃ©sents
  const g=state.goals;
  if(g.sport.bars[0].now>=5) addXP(30);
  if(g.sport.bars[1].now>=3) addXP(20);
  if(g.social.bars[0].now>=5) addXP(40);
  if(g.social.bars[1].now>=6) addXP(30);
  if(g.dev.bars[0].now>=5) addXP(25);
  if(g.dev.bars[1].now>=5) addXP(25);
  if(g.business.bars[2].now>=1) addXP(60);
  if(g.business.bars[2].now>=2) addXP(150);
  if(g.ugc.bars[1].now>=1) addXP(50);
  if(g.ugc.bars[1].now>=2) addXP(120);

  const day=state.byDate[currentDate]||{dailyDone:{},dailyXP:0,validated:false};
  day.validated=true; state.byDate[currentDate]=day;
  $("#date_validated").textContent='oui';
  save(); toast("JournÃ©e validÃ©e âœ…","success");
};

/* =============== RÃ©compenses + Inventaire =============== */
function canUseReward(reward){
  const a=state.malus.active;
  if(a.includes('no_rewards_daily')) return false;
  if(a.includes('no_rewards_weekend')&&(reward.id==='weekend'||reward.id==='day_off')) return false;
  if(a.includes('no_shopping')&&reward.id==='shopping') return false;
  if(a.includes('no_social')&&reward.id==='friends') return false;
  if(a.includes('no_pleasure')&&(reward.id==='activity'||reward.id==='day_off')) return false;
  return true;
}
function renderRewards(){
  const wrap=$("#rewards_list"), log=$("#rewards_log"); wrap.innerHTML="";
  state.rewards.catalog.forEach(it=>{
    const inv=state.rewards.inventory[it.id]||0;
    const blocked=!canUseReward(it);
    const card=document.createElement("div"); card.className="card half";
    card.innerHTML=`
      <div class="row">
        <div><h3 style="margin:.2rem 0">${it.name}</h3>
          <div class="muted small">${it.tag}${blocked?' â€” BLOQUÃ‰':''}</div></div>
        <b>${it.cost} XP</b>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button data-buy="${it.id}" class="ok">Acheter (+1)</button>
        <button data-use="${it.id}" ${inv<=0?'disabled':''}>Utiliser (reste: ${inv})</button>
        <button data-editreward="${it.id}" class="ghost ${state.edit?'':'hidden'}">âœï¸ Modifier</button>
        <button data-delreward="${it.id}" class="danger ${state.edit?'':'hidden'}">ğŸ—‘ï¸</button>
      </div>`;
    wrap.appendChild(card);
  });
  wrap.onclick=(e)=>{
    const buy=e.target.closest("[data-buy]"), use=e.target.closest("[data-use]"),
          ed=e.target.closest("[data-editreward]"), del=e.target.closest("[data-delreward]");
    if(buy){ const id=buy.dataset.buy; const it=state.rewards.catalog.find(x=>x.id===id); if(!it) return;
      if((state.profile.xp||0)<it.cost){toast("Pas assez d'XP","error");return}
      pushHistory(); state.profile.xp-=it.cost; state.rewards.inventory[id]=(state.rewards.inventory[id]||0)+1;
      state.rewards.log.unshift(`ğŸ›’ AchetÃ©: ${it.name} (âˆ’${it.cost} XP) â€” ${new Date().toLocaleString()}`);
      save(); updateXP(); renderRewards(); toast("RÃ©compense achetÃ©e","success"); return;
    }
    if(use){ const id=use.dataset.use; const inv=(state.rewards.inventory[id]||0); if(inv<=0) return;
      pushHistory(); state.rewards.inventory[id]=inv-1;
      const it=state.rewards.catalog.find(x=>x.id===id);
      state.rewards.log.unshift(`ğŸ UtilisÃ©: ${it?it.name:id} â€” ${new Date().toLocaleString()}`);
      save(); renderRewards(); toast("Utilisation OK","success"); return;
    }
    if(ed){ if(!state.edit) return; const id=ed.dataset.editreward; openRewardEditor(id); return; }
    if(del){ if(!state.edit) return; const id=del.dataset.delreward;
      pushHistory(); state.rewards.catalog=state.rewards.catalog.filter(r=>r.id!==id); delete state.rewards.inventory[id];
      save(); renderRewards(); toast("RÃ©compense supprimÃ©e","info"); return;
    }
  };
  log.innerHTML=state.rewards.log.slice(0,20).map(x=>`<li>${x}</li>`).join("");
}
function openRewardEditor(id){
  const r=state.rewards.catalog.find(x=>x.id===id); if(!r) return;
  $("#editModalTitle").textContent="Modifier la rÃ©compense";
  $("#editName").value=r.name; $("#editValue").value=r.cost; $("#editTag").value=r.tag;
  $("#editCategoryGroup").style.display="none"; $("#editTagGroup").style.display="block";
  currentEditType='reward'; currentEditId=id; $("#editModal").classList.add("active");
}

/* =============== MALUS =============== */
function malusPreview(){
  const rules=state.malus.rules, newMalus=[], newPen=[];
  if(state.profile.stats.dailyXP < (rules.dayMin||0)) newMalus.push('no_rewards_daily');
  if(state.profile.stats.weeklyXP < (rules.weekMin||0)) newMalus.push('no_rewards_weekend');
  const bizXP=calculateCategoryXP('business');
  if(bizXP < (rules.bizMin||0)) newMalus.push('no_shopping');

  const devLect = (state.goals.dev.bars.find(b=>b.id==='lectures')||{now:0}).now;
  if(devLect < (rules.readMin||0)) { newMalus.push('no_social'); newPen.push('1h lecture le dimanche') }

  if((state.goals.business.bars.find(b=>b.id==='mlm_inscriptions')||{now:0}).now===0){
    newPen.push('+50 prospections MLM obligatoires'); newPen.push('+5 appels tÃ©lÃ©phoniques obligatoires');
  }
  if((state.goals.ugc.bars.find(b=>b.id==='ugc_collabs')||{now:0}).now===0){
    newPen.push('+30 prospections UGC obligatoires');
  }
  if((state.goals.sport.bars.find(b=>b.id==='workouts')||{now:0}).now<3){
    newPen.push('Workout extra le week-end');
  }
  if((state.goals.sport.bars.find(b=>b.id==='runs')||{now:0}).now===0){
    newPen.push('Cardio long (45min) la semaine suivante');
  }
  if((state.goals.spirituality.bars.find(b=>b.id==='jumuah')||{now:0}).now===0){
    newPen.push('Lecture coranique (1h) le week-end');
  }
  return {newMalus,newPen};
}
function renderMalus(){
  const active=state.malus.active, pen=state.malus.penalties, rules=state.malus.rules;
  $("#rule_day_min").value=rules.dayMin||0;
  $("#rule_week_min").value=rules.weekMin||0;
  $("#rule_biz_min").value=rules.bizMin||0;
  $("#rule_read_min").value=rules.readMin||0;
  $("#malus_status").innerHTML = active.length? active.map(m=>`<div class="malus-item malus-active">${getMalusDescription(m)}</div>`).join("")
    : `<p class="muted">Aucun malus actif</p>` ;
  $("#malus_status").insertAdjacentHTML("beforeend", `<h4>PÃ©nalitÃ©s</h4>`+
    (pen.length? pen.map(p=>`<div class="malus-item">${p}</div>`).join("") : `<p class="muted">Aucune pÃ©nalitÃ©</p>`));
}
function renderMalusPreviewBox(){
  const {newMalus,newPen}=malusPreview();
  $("#malus_preview").innerHTML = `
    <div><b>Malus potentiels (${newMalus.length})</b><ul class="small">${newMalus.map(m=>`<li>${getMalusDescription(m)}</li>`).join("")||"<li>â€”</li>"}</ul></div>
    <div style="margin-top:6px"><b>PÃ©nalitÃ©s potentielles (${newPen.length})</b><ul class="small">${newPen.map(p=>`<li>${p}</li>`).join("")||"<li>â€”</li>"}</ul></div>
  `;
}
function getMalusDescription(m){
  const d={
    'no_rewards_daily':"ğŸš« Pas de rÃ©compense aujourd'hui (< min/jour)",
    'no_rewards_weekend':"ğŸš« Pas de rÃ©compense week-end (< min/semaine)",
    'no_shopping':"ğŸš« Pas de shopping (Business < min)",
    'no_social':"ğŸš« Pas de soirÃ©e amis (Lectures < min)",
    'no_pleasure':"ğŸš« Pas d'activitÃ© plaisir (<3 workouts/semaine)"
  };
  return d[m]||m;
}
function calculateCategoryXP(cat){
  let xp=0; ['daily','weekly','monthly'].forEach(scope=>{
    state.tasks[scope].forEach(t=>{ if(t.category===cat && t.done) xp+=t.xp; })
  }); return xp;
}
$("#btnPreviewMalus").onclick=()=>{renderMalusPreviewBox(); toast("AperÃ§u calculÃ©","info")};
$("#applyMalus,#applyMalus2").forEach?null: (Object.defineProperty(HTMLElement.prototype,'forEach',{value:function(){}}));
document.getElementById("applyMalus").onclick=applyMalusNow;
document.getElementById("applyMalus2").onclick=applyMalusNow;
function applyMalusNow(){
  pushHistory();
  const {newMalus,newPen}=malusPreview();
  state.malus.active=newMalus; state.malus.penalties=newPen;
  save(); renderMalus(); updateStreaks();
  toast(`Malus appliquÃ©s (${newMalus.length})`,"warning");
}
["rule_day_min","rule_week_min","rule_biz_min","rule_read_min"].forEach(id=>{
  const el=document.getElementById(id);
  el.oninput=()=>{ if(!state.edit) return; pushHistory();
    const v=+el.value||0; if(id==="rule_day_min") state.malus.rules.dayMin=v;
    if(id==="rule_week_min") state.malus.rules.weekMin=v;
    if(id==="rule_biz_min") state.malus.rules.bizMin=v;
    if(id==="rule_read_min") state.malus.rules.readMin=v;
    save(); renderMalusPreviewBox();
  };
});

/* =============== BONUS (exploits) =============== */
function renderBonus(){
  const wrap=$("#bonus_list");
  if(!state.bonus.length){
    wrap.innerHTML=`<p class="muted">Aucun bonus. (Mode Ã©dition â†’ â€œ+ Ajouter un bonusâ€)</p>`;
    return;
  }
  wrap.innerHTML=state.bonus.map(b=>{
    return `<div class="manage-item">
      <div><strong>${b.name}</strong><div class="muted small">+${b.xp} XP â€” ${b.claimed?"dÃ©jÃ  rÃ©clamÃ©":"disponible"}</div></div>
      <div class="manage-item-actions">
        <button data-claim="${b.id}" ${b.claimed?"disabled":""}>RÃ©clamer</button>
        <button data-editbonus="${b.id}" class="ghost ${state.edit?'':'hidden'}">âœï¸</button>
        <button data-delbonus="${b.id}" class="danger ${state.edit?'':'hidden'}">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join("");
  wrap.onclick=(e)=>{
    const c=e.target.closest("[data-claim]"), ed=e.target.closest("[data-editbonus]"), del=e.target.closest("[data-delbonus]");
    if(c){ const id=c.dataset.claim; const b=state.bonus.find(x=>x.id===id); if(!b||b.claimed) return;
      pushHistory(); b.claimed=true; save(); addXP(b.xp,c); renderBonus(); toast("Bonus rÃ©clamÃ© ğŸ‰","success"); }
    if(ed){ if(!state.edit) return; const id=ed.dataset.editbonus; openBonusEditor(id); }
    if(del){ if(!state.edit) return; const id=del.dataset.delbonus; pushHistory();
      state.bonus=state.bonus.filter(x=>x.id!==id); save(); renderBonus(); toast("Bonus supprimÃ©","info"); }
  };
}
$("#addBonus").onclick=()=>{ if(!state.edit) return;
  currentEditType='bonus'; currentEditId=null;
  $("#editModalTitle").textContent="Ajouter un bonus"; $("#editName").value=""; $("#editValue").value=50;
  $("#editCategoryGroup").style.display="none"; $("#editTagGroup").style.display="none";
  $("#editModal").classList.add("active");
};
function openBonusEditor(id){
  const b=state.bonus.find(x=>x.id===id); if(!b) return;
  currentEditType='bonus'; currentEditId=id;
  $("#editModalTitle").textContent="Modifier le bonus";
  $("#editName").value=b.name; $("#editValue").value=b.xp;
  $("#editCategoryGroup").style.display="none"; $("#editTagGroup").style.display="none";
  $("#editModal").classList.add("active");
}

/* =============== Export / Import / Reset =============== */
$("#exportData").onclick=()=>{
  const dataStr=JSON.stringify(state,null,2);
  const blob=new Blob([dataStr],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`gamelife-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast("Export OK","success");
};
$("#importData").onclick=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=(e)=>{
    const file=e.target.files[0]; if(!file) return; const rd=new FileReader();
    rd.onload=(ev)=>{ try{ pushHistory(); state=JSON.parse(ev.target.result); save(); init(); toast("Import OK","success"); }
      catch(err){ toast("Import invalide","error") } }; rd.readAsText(file);
  }; input.click();
};
$("#resetAll").onclick=()=>{ if(!confirm("Tout remettre Ã  zÃ©ro ?")) return; pushHistory(); state=dflt(); save(); init(); toast("Reset OK","info") };

/* =============== Modales (tÃ¢ches / rÃ©compenses / form) =============== */
let currentEditType=null, currentEditId=null;
function renderTaskManager(type){
  const list=$("#taskManageList"); const tasks=state.tasks[type];
  list.innerHTML = tasks.map(t=>`
    <div class="manage-item">
      <div><strong>${t.label}</strong><div class="muted small">${t.xp} XP â€” ${t.category}</div></div>
      <div class="manage-item-actions">
        <button onclick="editTask('${type}','${t.id}')" class="ghost">âœï¸</button>
        <button onclick="deleteTask('${type}','${t.id}')" class="danger">ğŸ—‘ï¸</button>
      </div>
    </div>`).join("");
}
function openTaskManager(type){ if(!state.edit){toast("Active le mode Ã©dition pour modifier","info");return}
  $("#taskModalTitle").textContent=`GÃ©rer les tÃ¢ches ${type}`; renderTaskManager(type); currentEditType=type; $("#taskModal").classList.add("active");
}
$("#manageDailyTasks").onclick=()=>openTaskManager('daily');
$("#manageWeeklyTasks").onclick=()=>openTaskManager('weekly');
$("#manageMonthlyTasks").onclick=()=>openTaskManager('monthly');
window.editTask=(type,id)=>{
  const t=state.tasks[type].find(x=>x.id===id); if(!t) return;
  $("#editModalTitle").textContent="Modifier la tÃ¢che";
  $("#editName").value=t.label; $("#editValue").value=t.xp; $("#editCategory").value=t.category;
  $("#editCategoryGroup").style.display="block"; $("#editTagGroup").style.display="none";
  currentEditType=type; currentEditId=id; $("#editModal").classList.add("active");
};
window.deleteTask=(type,id)=>{ if(!confirm("Supprimer cette tÃ¢che ?")) return; pushHistory();
  state.tasks[type]=state.tasks[type].filter(t=>t.id!==id); save(); renderTaskManager(type); renderTasksByCategory(); toast("TÃ¢che supprimÃ©e","info") };
$("#addNewTask").onclick=()=>{ if(!currentEditType) return;
  $("#editModalTitle").textContent="Ajouter une tÃ¢che";
  $("#editName").value=""; $("#editValue").value=10; $("#editCategory").value="discipline";
  $("#editCategoryGroup").style.display="block"; $("#editTagGroup").style.display="none";
  currentEditId=null; $("#editModal").classList.add("active");
};

$("#manageRewards").onclick=()=>{ if(!state.edit){toast("Active le mode Ã©dition","info");return}
  renderRewardManager(); $("#rewardModal").classList.add("active");
});
function renderRewardManager(){
  const list=$("#rewardManageList"), R=state.rewards.catalog;
  list.innerHTML=R.map(r=>`
    <div class="manage-item">
      <div><strong>${r.name}</strong><div class="muted small">${r.cost} XP â€” ${r.tag}</div></div>
      <div class="manage-item-actions">
        <button onclick="editReward('${r.id}')" class="ghost">âœï¸</button>
        <button onclick="deleteReward('${r.id}')" class="danger">ğŸ—‘ï¸</button>
      </div>
    </div>`).join("");
}
window.editReward=(id)=>openRewardEditor(id);
window.deleteReward=(id)=>{ if(!confirm("Supprimer ?")) return; pushHistory();
  state.rewards.catalog=state.rewards.catalog.filter(r=>r.id!==id); delete state.rewards.inventory[id];
  save(); renderRewardManager(); renderRewards(); toast("SupprimÃ©","info");
};

$("#closeTaskModal,#closeRewardModal,#cancelEdit").forEach?null:(Object.defineProperty(HTMLElement.prototype,'forEach',{value:function(){}}));
["closeTaskModal","closeRewardModal","cancelEdit"].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  el.onclick=()=>{ $("#taskModal").classList.remove("active"); $("#rewardModal").classList.remove("active"); $("#editModal").classList.remove("active") };
});
document.getElementById("taskModal").addEventListener("click",e=>{ if(e.target.classList.contains("modal")) e.target.classList.remove("active") });
document.getElementById("rewardModal").addEventListener("click",e=>{ if(e.target.classList.contains("modal")) e.target.classList.remove("active") });
document.getElementById("editModal").addEventListener("click",e=>{ if(e.target.classList.contains("modal")) e.target.classList.remove("active") });

/* ====== Formulaire dâ€™Ã©dition (tÃ¢ches / reward / bonus) ====== */
document.getElementById("editForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const name=$("#editName").value.trim(), value=parseInt($("#editValue").value);
  if(!name || !value){toast("Champs invalides","error");return}
  pushHistory();
  if(currentEditType==='reward'){
    const tag=$("#editTag").value.trim();
    if(currentEditId){ const r=state.rewards.catalog.find(x=>x.id===currentEditId); if(r){r.name=name;r.cost=value;r.tag=tag} }
    else{ state.rewards.catalog.push({id:'rw_'+Date.now(),name,cost:value,tag}); }
    save(); renderRewardManager(); renderRewards();
  }else if(currentEditType==='bonus'){
    if(currentEditId){ const b=state.bonus.find(x=>x.id===currentEditId); if(b){b.name=name;b.xp=value} }
    else{ state.bonus.push({id:'bn_'+Date.now(),name,xp:value,claimed:false}) }
    save(); renderBonus();
  }else{
    const cat=$("#editCategory").value;
    if(currentEditId){ const t=state.tasks[currentEditType].find(x=>x.id===currentEditId); if(t){t.label=name;t.xp=value;t.category=cat} }
    else{ state.tasks[currentEditType].push({id:'tsk_'+Date.now(),label:name,xp:value,category:cat,done:false}) }
    save(); renderTaskManager(currentEditType); renderTasksByCategory();
  }
  $("#editModal").classList.remove("active"); toast("SauvegardÃ©","success");
});

/* =============== Bonus de streak priÃ¨res (7 jours) =============== */
function checkBonuses(){
  if(state.profile.streaks.prayer>=7 && state.profile.streaks.prayer%7===0){
    addXP(50); toast("ğŸ‰ Bonus streak priÃ¨res +50 XP!","success");
  }
}

/* =============== Sector Gauges =============== */
function getWeeklySectorXP(){
  const W={biz:0,ugc:0,sport:0,dev:0,spi:0};
  ['daily','weekly','monthly'].forEach(scope=>{
    state.tasks[scope].forEach(t=>{
      if(!t.done) return;
      if(t.category==='business') W.biz+=t.xp;
      if(t.category==='ugc') W.ugc+=t.xp;
      if(t.category==='sport') W.sport+=t.xp;
      if(t.category==='dev') W.dev+=t.xp;
      if(t.category==='spirituality') W.spi+=t.xp;
    });
  }); return W;
}
function renderSectorGauges(){
  const W=getWeeklySectorXP();
  const set=(fill,txt,now,goal)=>{ const f=$("#"+fill), t=$("#"+txt), p=goal?Math.min(100,Math.round(now/goal*100)):0; if(f) f.style.width=p+"%"; if(t) t.textContent=`${now}/${goal}`; };
  set('g_biz','g_biz_txt',W.biz,100);
  set('g_ugc','g_ugc_txt',W.ugc,100);
  set('g_sport','g_sport_txt',W.sport,60);
  set('g_dev','g_dev_txt',W.dev,50);
  set('g_spi','g_spi_txt',W.spi,60);
}

/* =============== Auto-hide nav =============== */
let lastScrollY=0,ticking=false;
function updateNavbar(){
  const y=window.scrollY, nav=$(".top");
  if(y>lastScrollY && y>100) nav.classList.add("hidden"); else nav.classList.remove("hidden");
  lastScrollY=y; ticking=false;
}
window.addEventListener("scroll",()=>{ if(!ticking){ requestAnimationFrame(updateNavbar); ticking=true }});

/* =============== INIT =============== */
function init(){
  // sÃ©curitÃ© migration anciennes clÃ©s
  if(!state.profile) state.profile={name:"",level:1,xp:0,streaks:{prayer:0},stats:{dailyXP:0,weeklyXP:0,monthlyXP:0}};
  if(!state.malus||!state.malus.rules) state.malus={rules:{dayMin:100,weekMin:250,bizMin:100,readMin:3},active:[],penalties:[]};
  drawPlayerName();
  $("#player_name").value=state.profile.name||"";
  $("#selected_date").value=currentDate;
  renderKPIs(); renderTasksByCategory(); renderRewards(); renderMalus(); renderMalusPreviewBox(); renderBonus(); renderMoney();
  renderPriorities(); renderSectorGauges(); updateXP(); updateStreaks(); applyEditModeUI(); loadDay(currentDate);
}
init();
</script>
</body>
</html>
