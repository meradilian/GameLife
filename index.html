<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Game Life ⭐</title>
<style>
  :root{
    --bg:#0b0f14;--bg2:#0f1520;--card:#121826;--text:#e6edf3;--muted:#9fb3c8;
    --line:rgba(255,255,255,.12);--grad:linear-gradient(90deg,#6ee7ff,#a78bfa);
    --danger:#ff6b6b;--warning:#ffa726
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text)}
  .top{position:fixed;top:0;left:0;right:0;z-index:10;background:rgba(11,15,20,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--line);transition:transform .3s ease-in-out}
  .top.hidden{transform:translateY(-100%)}
  .container{width:min(1100px,94vw);margin:0 auto;padding:70px 0 40px}
  .header-content{display:flex;align-items:center;justify-content:space-between;padding:8px}
  .title{flex:1;text-align:center}
  .title h1{margin:0;font-size:1.2rem}
  .title p{margin:0;font-size:.75rem}
  .muted{color:var(--muted)}
  .menu-toggle,.back-btn-header{background:none;border:none;color:var(--text);cursor:pointer;border-radius:8px}
  .menu-toggle{font-size:1.5rem;padding:8px}
  .back-btn-header{font-size:1rem;padding:8px}
  .menu-toggle:hover,.back-btn-header:hover{background:rgba(255,255,255,.1)}
  .mobile-menu{position:absolute;top:100%;left:0;right:0;background:rgba(11,15,20,.98);backdrop-filter:blur(12px);border-bottom:1px solid var(--line);display:none;flex-direction:column;padding:8px;gap:4px}
  .mobile-menu.show{display:flex}
  .tab{padding:.5rem .8rem;border-radius:8px;border:1px solid var(--line);background:#0d1520;color:var(--text);cursor:pointer;font-size:.9rem;text-align:left;width:100%}
  .tab.active{border-color:rgba(255,255,255,.35)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px;transition:transform .2s, box-shadow .2s}
  .card:hover{transform:translateY(-1px);box-shadow:0 4px 18px rgba(110,231,255,.08)}
  .player{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;flex-wrap:wrap}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .bar{height:12px;border-radius:999px;background:#0e1622;border:1px solid var(--line);overflow:hidden}
  .bar>span{display:block;height:100%;background:var(--grad);width:0%;transition:width .5s ease-out}
  .chip{background:#0e1622;border:1px solid var(--line);border-radius:999px;padding:.3rem .6rem;color:var(--muted);font-size:.9rem}
  button{padding:.55rem .85rem;border-radius:10px;border:1px solid var(--line);background:#0d1520;color:var(--text);cursor:pointer}
  button.ghost{opacity:.85}
  button.danger{background:#4a1e1e;border-color:#8b3a3a}
  button.warning{background:#5a3a1e;border-color:#8b6a3a}
  .kpis{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .kpi{grid-column:span 12;background:#0f1726;border:1px solid var(--line);border-radius:12px;padding:12px}
  @media(min-width:860px){.kpi{grid-column:span 6}}
  input[type="number"],input[type="text"],input[type="date"]{padding:.45rem;border-radius:10px;border:1px solid var(--line);background:#0c121a;color:var(--text);text-align:center}
  input[type="number"]{width:110px}
  input[type="text"]{min-width:150px;text-align:left}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .half{grid-column:span 12} @media(min-width:860px){.half{grid-column:span 6}}
  #toast{position:fixed;right:14px;bottom:14px;padding:12px 16px;background:#0f1726;border:1px solid var(--line);border-radius:10px;opacity:0;transition:.3s;transform:translateY(20px);z-index:1000}
  #toast.show{opacity:1;transform:translateY(0)}
  #toast.success{background:#1a4a3a;border-color:#2d8a5a;color:#4ade80}
  #toast.error{background:#4a1e1e;border-color:#8b3a3a;color:#f87171}
  #toast.info{background:#1e3a8a;border-color:#3b82f6;color:#60a5fa}
  #toast.warning{background:#5a3a1e;border-color:#8b6a3a;color:#ffa726}
  .xp-gain,.xp-loss{position:fixed;font-weight:bold;pointer-events:none;animation:xpFloat 2s ease-out forwards;z-index:1001}
  .xp-gain{color:#fbbf24}.xp-loss{color:#ff6b6b}
  @keyframes xpFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
  .level-up{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--grad);color:#000;padding:20px 40px;border-radius:20px;font-size:1.5rem;font-weight:bold;z-index:1002;animation:levelUpPulse 3s ease-out forwards}
  @keyframes levelUpPulse{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}40%{transform:translate(-50%,-50%) scale(1)}100%{opacity:0}}
  .quest{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)}
  .view{display:none}.view.active{display:block}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;z-index:100;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px;width:min(500px,90vw);max-height:80vh;overflow-y:auto}
  .form-group{margin-bottom:16px}.form-group label{display:block;margin-bottom:8px;color:var(--text)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:.3rem .6rem;border-radius:999px;background:#142033;border:1px solid rgba(255,255,255,.12);color:#cde3ff}
  .badge i{font-style:normal;background:#1a2a44;padding:2px 6px;border-radius:6px}
  .gbar{height:12px;border-radius:999px;background:#0e1622;border:1px solid var(--line);overflow:hidden;position:relative}
  .gfill{height:100%;background:var(--grad);width:0%;transition:width .5s}
  .row.wrap{flex-wrap:wrap;gap:8px}
  .section-title{display:flex;justify-content:space-between;align-items:center;gap:10px}
</style>
</head>
<body>
<header class="top">
  <div class="header-content">
    <button id="backButton" class="back-btn-header" style="display:none">← Retour</button>
    <div class="title">
      <h1>⭐ Game Life</h1>
      <p class="muted">c'est toi qui choisis de stagner ou d'évoluer</p>
    </div>
    <button id="menuToggle" class="menu-toggle">☰</button>
  </div>
  <nav id="mobileMenu" class="mobile-menu">
    <button class="tab active" data-goto="goals">🎯 Objectifs</button>
    <button class="tab" data-goto="tasks">✅ Tâches</button>
    <button class="tab" data-goto="rewards">🎁 Récompenses</button>
    <button class="tab" data-goto="malus">⚠️ Malus</button>
    <button class="tab" data-goto="stats">📊 Statistiques</button>
    <button id="exportData" class="ghost">📤 Exporter</button>
  </nav>
</header>

<main class="container">
  <!-- PLAYER -->
  <section class="card">
    <div class="player">
      <div>
        <h2>
          <span id="player_title_name">🎮 Joueur</span>
          <span class="badge"><i>Lvl</i><b id="level">1</b></span>
        </h2>

        <div class="row" style="margin:6px 0 4px">
          <label class="muted">Pseudo :</label>
          <input id="player_name" type="text" placeholder="Ton nom" style="width:180px">
          <button id="saveName" class="ghost">Enregistrer</button>
        </div>

        <div class="row wrap" style="margin:6px 0">
          <label class="muted">Jour :</label>
          <input id="selected_date" type="date"/>
          <span class="chip">Validé : <b id="date_validated">non</b></span>
        </div>

        <!-- ARGENT -->
        <div class="card" style="margin-top:10px">
          <div class="section-title"><h3 style="margin:0">💰 Argent</h3>
            <div class="row" style="gap:8px">
              <button id="toggleEdit" class="ghost">✏️ Modifier</button>
              <button id="saveAll" class="ghost">💾 Enregistrer</button>
            </div>
          </div>
          <div class="grid" style="margin-top:8px">
            <div class="half">
              <h4 style="margin:.2rem 0">Semaine</h4>
              <div class="row"><span>Objectif</span>
                <input id="money_week_goal" type="number" min="0" value="0" disabled>
              </div>
              <div class="row"><span>Fait</span>
                <input id="money_week_done" type="number" min="0" value="0">
              </div>
              <div class="row"><span>Reste</span><b id="money_week_left">0</b></div>
            </div>
            <div class="half">
              <h4 style="margin:.2rem 0">Mois</h4>
              <div class="row"><span>Objectif</span>
                <input id="money_month_goal" type="number" min="0" value="0" disabled>
              </div>
              <div class="row"><span>Fait</span>
                <input id="money_month_done" type="number" min="0" value="0">
              </div>
              <div class="row"><span>Reste</span><b id="money_month_left">0</b></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px"><strong>XP</strong><span id="xp_text">0 / 100</span></div>
        <div class="gbar"><span id="xp_bar" class="gfill" style="width:0%"></span></div>
        <div class="row wrap" style="margin-top:8px">
          <span class="chip">🕌 Streak prières: <b id="streak_pr">0</b> j</span>
          <span class="chip">🚫 Malus actifs: <b id="active_malus">0</b></span>
        </div>
      </div>

      <div class="row" style="gap:8px">
        <button id="validateDay">Valider la journée</button>
        <button id="checkMalus" class="warning">Vérifier malus</button>
        <button id="importData" class="ghost">📥 Importer</button>
        <button id="resetAll" class="ghost">🔄 Reset</button>
      </div>
    </div>
  </section>

  <!-- GOALS -->
  <section id="view-goals" class="view active">
    <section class="card">
      <h2>Objectifs hebdomadaires</h2>
      <!-- Mini jauges secteur -->
      <div id="sector_gauges" class="grid" style="margin-top:8px">
        <div class="half card"><div class="row"><b>💸 Business</b><span id="g_biz_txt">0/100</span></div><div class="gbar"><span id="g_biz" class="gfill"></span></div></div>
        <div class="half card"><div class="row"><b>🎥 UGC</b><span id="g_ugc_txt">0/100</span></div><div class="gbar"><span id="g_ugc" class="gfill"></span></div></div>
        <div class="half card"><div class="row"><b>🏋️ Sport</b><span id="g_sport_txt">0/60</span></div><div class="gbar"><span id="g_sport" class="gfill"></span></div></div>
        <div class="half card"><div class="row"><b>📚 Dév perso</b><span id="g_dev_txt">0/50</span></div><div class="gbar"><span id="g_dev" class="gfill"></span></div></div>
        <div class="half card"><div class="row"><b>🕌 Spiritualité</b><span id="g_spi_txt">0/60</span></div><div class="gbar"><span id="g_spi" class="gfill"></span></div></div>
      </div>
      <div id="kpis" class="kpis"></div>
    </section>
  </section>

  <!-- TASKS -->
  <section id="view-tasks" class="view">
    <section class="card">
      <h2>Tâches quotidiennes</h2>
      <div class="category-actions">
        <button id="manageDailyTasks" class="ghost">✏️ Gérer les tâches</button>
        <button id="resetDaily" class="ghost">Réinitialiser la journée</button>
      </div>
      <div id="daily_tasks"></div>
    </section>
    <section class="card">
      <h2>Tâches hebdomadaires</h2>
      <div class="category-actions">
        <button id="manageWeeklyTasks" class="ghost">✏️ Gérer les tâches</button>
        <button id="resetWeekly" class="ghost">Réinitialiser la semaine</button>
      </div>
      <div id="weekly_tasks"></div>
    </section>
    <section class="card">
      <h2>Tâches mensuelles</h2>
      <div class="category-actions">
        <button id="manageMonthlyTasks" class="ghost">✏️ Gérer les tâches</button>
        <button id="resetMonthly" class="ghost">Réinitialiser le mois</button>
      </div>
      <div id="monthly_tasks"></div>
    </section>
  </section>

  <!-- REWARDS -->
  <section id="view-rewards" class="view">
    <section class="card">
      <h2>Récompenses disponibles</h2>
      <div class="category-actions">
        <button id="manageRewards" class="ghost">✏️ Gérer les récompenses</button>
      </div>
      <div id="rewards_list" class="grid"></div>
    </section>
    <section class="card">
      <h2>Historique des récompenses</h2>
      <ul id="rewards_log" class="muted"></ul>
    </section>
  </section>

  <!-- MALUS -->
  <section id="view-malus" class="view">
    <section class="card">
      <h2>⚠️ Système de malus</h2>
      <div id="malus_status"></div>
      <button id="applyMalus" class="danger">Appliquer les malus</button>
    </section>
  </section>

  <!-- STATS -->
  <section id="view-stats" class="view">
    <section class="card">
      <h2>📊 Statistiques</h2>
      <div id="stats_content"></div>
    </section>
  </section>
</main>

<div id="toast"></div>

<!-- MODALES -->
<div id="taskModal" class="modal">
  <div class="modal-content">
    <h2 id="taskModalTitle">Gérer les tâches</h2>
    <div id="taskManageList"></div>
    <button id="addNewTask">+ Ajouter une tâche</button>
    <div class="category-actions"><button id="closeTaskModal">Fermer</button></div>
  </div>
</div>

<div id="rewardModal" class="modal">
  <div class="modal-content">
    <h2>Gérer les récompenses</h2>
    <div id="rewardManageList"></div>
    <button id="addNewReward">+ Ajouter une récompense</button>
    <div class="category-actions"><button id="closeRewardModal">Fermer</button></div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h2 id="editModalTitle">Modifier</h2>
    <form id="editForm">
      <div class="form-group">
        <label for="editName">Nom :</label>
        <input type="text" id="editName" required>
      </div>
      <div class="form-group">
        <label for="editValue">Valeur :</label>
        <input type="number" id="editValue" required>
      </div>
      <div class="form-group" id="editCategoryGroup">
        <label for="editCategory">Catégorie :</label>
        <select id="editCategory">
          <option value="discipline">Discipline</option>
          <option value="business">Business</option>
          <option value="ugc">UGC</option>
          <option value="sport">Sport</option>
          <option value="social">Social</option>
          <option value="dev">Développement</option>
          <option value="spirituality">Spiritualité</option>
        </select>
      </div>
      <div class="form-group" id="editTagGroup">
        <label for="editTag">Tag :</label>
        <input type="text" id="editTag">
      </div>
      <div class="category-actions">
        <button type="submit">Sauvegarder</button>
        <button type="button" id="cancelEdit">Annuler</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ====== STATE ====== */
const KEY="gamelife_v2";
function dflt(){
  return{
    profile:{level:1,xp:0,name:"",streaks:{prayer:0},stats:{dailyXP:0,weeklyXP:0,monthlyXP:0}},
    money:{week:{goal:0,done:0},month:{goal:0,done:0}},
    goals:{
      discipline:{label:"⏰ Discipline/Réveil",bars:[
        {id:"wake_early",label:"Réveils avant 8h",now:0,goal:7},
        {id:"wake_very_early",label:"Réveils avant 7h",now:0,goal:3},
        {id:"wake_extreme",label:"Réveils avant 6h",now:0,goal:1}
      ]},
      business:{label:"💸 Business MLM",bars:[
        {id:"mlm_prospects",label:"Prospections MLM",now:0,goal:140},
        {id:"mlm_presentations",label:"Présentations",now:0,goal:7},
        {id:"mlm_inscriptions",label:"Inscriptions",now:0,goal:1}
      ]},
      ugc:{label:"🎥 UGC",bars:[
        {id:"ugc_prospects",label:"Prospections marques",now:0,goal:140},
        {id:"ugc_collabs",label:"Collabs signées",now:0,goal:1}
      ]},
      sport:{label:"🏋️ Sport",bars:[
        {id:"workouts",label:"Workouts",now:0,goal:5},
        {id:"runs",label:"Courses",now:0,goal:3}
      ]},
      social:{label:"📱 Réseaux sociaux",bars:[
        {id:"reels",label:"Reels postés",now:0,goal:5},
        {id:"videos",label:"Vidéos produites",now:0,goal:6}
      ]},
      dev:{label:"📚 Développement perso",bars:[
        {id:"lectures",label:"Lectures (20min)",now:0,goal:5},
        {id:"introspections",label:"Introspections",now:0,goal:5}
      ]},
      spirituality:{label:"🕌 Spiritualité",bars:[
        {id:"daily_prayers",label:"Journées 5 prières",now:0,goal:7},
        {id:"jumuah",label:"Jumu'ah",now:0,goal:1}
      ]}
    },
    tasks:{
      daily:[
        {id:"wake_early",label:"Réveil avant 8h",xp:10,done:false,category:"discipline"},
        {id:"wake_very_early",label:"Réveil avant 7h",xp:20,done:false,category:"discipline"},
        {id:"wake_extreme",label:"Réveil avant 6h",xp:30,done:false,category:"discipline"},
        {id:"prayers_5",label:"5 prières du jour",xp:25,done:false,category:"spirituality"},
        {id:"mlm_prospect_20",label:"20 prospections MLM",xp:22,done:false,category:"business"},
        {id:"ugc_prospect_20",label:"20 prospections UGC",xp:22,done:false,category:"ugc"},
        {id:"workout",label:"1 workout",xp:10,done:false,category:"sport"},
        {id:"run",label:"1 course",xp:12,done:false,category:"sport"},
        {id:"reel",label:"1 reel posté",xp:8,done:false,category:"social"},
        {id:"video",label:"1 vidéo produite",xp:5,done:false,category:"social"},
        {id:"lecture",label:"Lecture 20min",xp:8,done:false,category:"dev"},
        {id:"introspection",label:"Introspection courte",xp:8,done:false,category:"dev"}
      ],
      weekly:[
        {id:"jumuah",label:"Jumu'ah",xp:30,done:false,category:"spirituality"},
        {id:"big_introspection",label:"Grosse introspection",xp:30,done:false,category:"dev"},
        {id:"mlm_presentation",label:"Présentation MLM",xp:5,done:false,category:"business"},
        {id:"ugc_collab",label:"Collab UGC signée",xp:50,done:false,category:"ugc"}
      ],
      monthly:[]
    },
    rewards:{catalog:[
      {id:"film",name:"Film/épisode (1h30)",cost:100,tag:"Détente",blocked:false},
      {id:"activity",name:"Activité plaisir (1-2h)",cost:150,tag:"Plaisir",blocked:false},
      {id:"friends",name:"Soirée amis/famille",cost:200,tag:"Social",blocked:false},
      {id:"spa",name:"Spa/détente (2h)",cost:250,tag:"Bien-être",blocked:false},
      {id:"shopping",name:"Shopping ≤50 CHF",cost:300,tag:"Shopping",blocked:false},
      {id:"day_off",name:"Day off complet",cost:300,tag:"Repos",blocked:false},
      {id:"weekend",name:"Weekend détente",cost:800,tag:"Voyage",blocked:false}
    ],log:[]},
    malus:{active:[],penalties:[]},
    byDate:{} // 'YYYY-MM-DD': { dailyDone:{id:true}, dailyXP:number, validated:boolean }
  }
}
let state = load();
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||dflt();}catch(e){return dflt();} }
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

/* ====== UI helpers ====== */
function toast(text,type='info'){const el=$("#toast");el.textContent=text;el.className=type;el.classList.add('show');setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.className='',300);},2200);}
function showXPGain(amount,element){const xpEl=document.createElement('div');xpEl.className=amount>0?'xp-gain':'xp-loss';xpEl.textContent=amount>0?`+${amount} XP`:`${amount} XP`;const r=element.getBoundingClientRect();xpEl.style.left=r.left+r.width/2+'px';xpEl.style.top=r.top+'px';document.body.appendChild(xpEl);setTimeout(()=>xpEl.remove(),2000);}
function showLevelUp(level){const el=document.createElement('div');el.className='level-up';el.textContent=`🎉 NIVEAU ${level} ! 🎉`;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}

/* ====== MENU / NAV ====== */
$("#menuToggle").addEventListener("click",()=>$("#mobileMenu").classList.toggle("show"));
document.addEventListener("click",(e)=>{const m=$("#mobileMenu"),t=$("#menuToggle");if(!m.contains(e.target)&&!t.contains(e.target))m.classList.remove("show");});
$$(".tab").forEach(b=>b.addEventListener("click",()=>{
  $$(".tab").forEach(t=>t.classList.remove("active")); b.classList.add("active");
  $$(".view").forEach(v=>v.classList.remove("active"));
  const id="view-"+b.dataset.goto; $("#"+id).classList.add("active");
  $("#mobileMenu").classList.remove("show");
  $("#backButton").style.display = b.dataset.goto==="goals"?"none":"block";
}));
$("#backButton").addEventListener("click",()=>{
  $$(".view").forEach(v=>v.classList.remove("active"));
  $("#view-goals").classList.add("active");
  $$(".tab").forEach(t=>t.classList.remove("active"));
  $(".tab[data-goto='goals']").classList.add("active");
  $("#backButton").style.display="none";
});

/* ====== XP ====== */
function xpNeed(l){return 50+l*50;}
function updateXP(){
  const need=xpNeed(state.profile.level);
  const xp=Math.max(0,state.profile.xp||0);
  $("#xp_text").textContent=`${xp} / ${need}`;
  $("#xp_bar").style.width=Math.min(100,Math.round((xp/need)*100))+"%";
  $("#level").textContent=state.profile.level;
}
function addXP(x,src=null){
  state.profile.xp=Math.max(0,(state.profile.xp||0)+x);
  state.profile.stats.dailyXP+=x;
  state.profile.stats.weeklyXP+=x;
  state.profile.stats.monthlyXP+=x;
  if(src) showXPGain(x,src);
  while(state.profile.xp>=xpNeed(state.profile.level)){
    state.profile.xp-=xpNeed(state.profile.level); state.profile.level++; showLevelUp(state.profile.level); toast(`Niveau ${state.profile.level} !`,'success');
  }
  save(); updateXP(); updateStreaks();
}
function updateStreaks(){
  $("#streak_pr").textContent=state.profile.streaks.prayer||0;
  $("#active_malus").textContent=state.malus.active.length||0;
}

/* ====== Money ====== */
function renderMoney(){
  $("#money_week_goal").value = state.money.week.goal||0;
  $("#money_week_done").value = state.money.week.done||0;
  $("#money_month_goal").value = state.money.month.goal||0;
  $("#money_month_done").value = state.money.month.done||0;
  updateMoneyLeftLive();
}
function collectMoneyIntoState(){
  state.money.week.goal = +($("#money_week_goal").value||0);
  state.money.week.done = +($("#money_week_done").value||0);
  state.money.month.goal = +($("#money_month_goal").value||0);
  state.money.month.done = +($("#money_month_done").value||0);
}
function updateMoneyLeftLive(){
  const wGoal=+( $("#money_week_goal").value||0 ), wDone=+( $("#money_week_done").value||0 );
  const mGoal=+( $("#money_month_goal").value||0 ), mDone=+( $("#money_month_done").value||0 );
  $("#money_week_left").textContent = Math.max(0, wGoal - wDone);
  $("#money_month_left").textContent = Math.max(0, mGoal - mDone);
}
/* live update sans rerender */
["money_week_done","money_month_done","money_week_goal","money_month_goal"].forEach(id=>{
  const el=$("#"+id); if(!el) return;
  el.addEventListener("input",()=>{ updateMoneyLeftLive(); markDirty(); });
});

/* ====== Edit mode / Save all ====== */
let editMode=false, dirty=false;
function markDirty(v=true){ dirty=v; setSaveButtonVisual(); }
function setSaveButtonVisual(){ $("#saveAll").style.borderColor = dirty? "rgba(110,231,255,.6)": "var(--line)"; }
$("#toggleEdit").addEventListener("click",()=>{
  editMode=!editMode;
  $("#toggleEdit").textContent = editMode? "✅ Terminer" : "✏️ Modifier";
  // champs protégés
  $("#money_week_goal").disabled = !editMode;
  $("#money_month_goal").disabled = !editMode;
  // objectifs (inputs _goal/_now)
  $$("#kpis input").forEach(inp=>{ const isGoal=/_goal$/.test(inp.id); inp.disabled = isGoal ? !editMode : false; });
});
$("#saveAll").addEventListener("click",()=>{
  collectMoneyIntoState(); updateMoneyLeftLive();
  // sauver date du jour
  saveDay(currentDate);
  save(); markDirty(false); toast("Enregistré ✅",'success');
});

/* ====== Goals (KPIs) ====== */
function pct(n,g){n=Math.max(0,+n||0);g=Math.max(0,+g||0);return g?Math.min(100,Math.round(n/g*100)):0;}
function renderKPIs(){
  const kpis=$("#kpis"); kpis.innerHTML="";
  for(const [key,cat] of Object.entries(state.goals)){
    const card=document.createElement("div"); card.className="kpi"; card.dataset.cat=key;
    let html=`<h3>${cat.label}</h3>`;
    cat.bars.forEach(b=>{
      const p=pct(b.now,b.goal);
      html+=`<div class="row"><strong>${b.label}</strong>
      <span>
        <input id="${b.id}_now" type="number" value="${b.now}" min="0"${editMode?"":" "}>
        /
        <input id="${b.id}_goal" type="number" value="${b.goal}" min="0"${editMode?"":" disabled"}>
      </span></div>
      <div class="bar"><span id="${b.id}_bar" style="width:${p}%"></span></div>`;
    });
    card.innerHTML=html; kpis.appendChild(card);
  }
  // Bind
  for(const cat of Object.values(state.goals)){
    cat.bars.forEach(b=>{
      const now=$("#"+b.id+"_now"), goal=$("#"+b.id+"_goal"), bar=$("#"+b.id+"_bar");
      const recalc=()=>{ b.now=+now.value||0; b.goal=+goal.value||0; if(bar) bar.style.width = pct(b.now,b.goal)+'%'; markDirty(); save(); };
      now.addEventListener("input",recalc);
      goal.addEventListener("input",recalc);
    });
  }
}
function updateGoalFromTask(goalId,amount=1){
  for(const cat of Object.values(state.goals)){
    const bar=cat.bars.find(x=>x.id===goalId);
    if(bar){ bar.now+=amount; updateGoalUI(goalId,bar.now,bar.goal); return; }
  }
}
function updateGoalUI(goalId,now,goal){
  const nowEl=$("#"+goalId+"_now"), goalEl=$("#"+goalId+"_goal"), bar=$("#"+goalId+"_bar");
  if(nowEl) nowEl.value = now;
  if(goalEl && document.activeElement!==goalEl) goalEl.value = goal;
  if(bar) bar.style.width = pct(now,goal)+"%";
  markDirty();
}

/* ====== Sector XP gauges ====== */
function getWeeklySectorXP(){
  const W={biz:0,ugc:0,sport:0,dev:0,spi:0};
  ['daily','weekly','monthly'].forEach(scope=>{
    state.tasks[scope].forEach(t=>{
      if(!t.done) return;
      if(t.category==='business') W.biz+=t.xp;
      if(t.category==='ugc') W.ugc+=t.xp;
      if(t.category==='sport') W.sport+=t.xp;
      if(t.category==='dev') W.dev+=t.xp;
      if(t.category==='spirituality') W.spi+=t.xp;
    });
  });
  return W;
}
function renderSectorGauges(){
  const W=getWeeklySectorXP();
  const set=(fillId,txtId,now,goal)=>{ const f=$("#"+fillId),t=$("#"+txtId),p=goal?Math.min(100,Math.round(now/goal*100)):0; if(f) f.style.width=p+"%"; if(t) t.textContent=`${now}/${goal}`; };
  set('g_biz','g_biz_txt',W.biz,100);
  set('g_ugc','g_ugc_txt',W.ugc,100);
  set('g_sport','g_sport_txt',W.sport,60);
  set('g_dev','g_dev_txt',W.dev,50);
  set('g_spi','g_spi_txt',W.spi,60);
}

/* ====== Tasks ====== */
function renderTasks(){
  const mount=(id,list)=>{
    const el=$("#"+id); el.innerHTML="";
    list.forEach(t=>{
      const row=document.createElement("div"); row.className="quest";
      row.innerHTML=`<label><input type="checkbox" data-scope="${id}" data-id="${t.id}" ${t.done?'checked':''}> ${t.label}</label><span class="muted">+${t.xp} XP</span>`;
      el.appendChild(row);
    });
  };
  mount("daily_tasks",state.tasks.daily);
  mount("weekly_tasks",state.tasks.weekly);
  mount("monthly_tasks",state.tasks.monthly);
}
document.addEventListener("change",(e)=>{
  const el=e.target;
  if(!el.matches('input[type="checkbox"][data-scope]')) return;
  const scope=el.getAttribute("data-scope"), id=el.getAttribute("data-id");
  const list= scope==="daily_tasks"?state.tasks.daily : scope==="weekly_tasks"?state.tasks.weekly : state.tasks.monthly;
  const t=list.find(x=>x.id===id); if(!t) return;
  const was=t.done; t.done=el.checked;

  // règles spéciales
  if(t.id==="prayers_5" && t.done && !was){ state.profile.streaks.prayer++; updateGoalFromTask("daily_prayers"); }
  if(t.id==="prayers_5" && !t.done && was){ state.profile.streaks.prayer=Math.max(0,state.profile.streaks.prayer-1); }

  if(t.id==="mlm_prospect_20" && t.done && !was) updateGoalFromTask("mlm_prospects",20);
  if(t.id==="ugc_prospect_20" && t.done && !was) updateGoalFromTask("ugc_prospects",20);

  const map={workout:"workouts",run:"runs",reel:"reels",video:"videos",lecture:"lectures",introspection:"introspections",jumuah:"jumuah",mlm_presentation:"mlm_presentations",ugc_collab:"ugc_collabs"};
  if(map[t.id] && t.done && !was) updateGoalFromTask(map[t.id]);

  addXP(t.done? t.xp : -t.xp, el.closest('.quest'));
  if(t.done) toast(`Tâche : ${t.label} (+${t.xp} XP)`,'success');

  saveDay(currentDate); renderSectorGauges(); markDirty(); // pas de renderKPIs complet ici → pas de lag
});

/* Reset boutons */
$("#resetDaily").addEventListener("click",()=>{state.tasks.daily.forEach(t=>t.done=false);saveDay(currentDate);save();renderTasks();});
$("#resetWeekly").addEventListener("click",()=>{state.tasks.weekly.forEach(t=>t.done=false);save();renderTasks();});
$("#resetMonthly").addEventListener("click",()=>{state.tasks.monthly.forEach(t=>t.done=false);save();renderTasks();});

/* ====== Validate Day ====== */
$("#validateDay").addEventListener("click",()=>{
  // bonus simples
  const g=state.goals;
  if(g.sport.bars[0].now>=5) addXP(30);
  if(g.sport.bars[1].now>=3) addXP(20);
  if(g.social.bars[0].now>=5) addXP(40);
  if(g.social.bars[1].now>=6) addXP(30);
  if(g.dev.bars[0].now>=5) addXP(25);
  if(g.dev.bars[1].now>=5) addXP(25);
  if(g.business.bars[2].now>=1) addXP(60);
  if(g.business.bars[2].now>=2) addXP(150);
  if(g.ugc.bars[1].now>=1) addXP(50);
  if(g.ugc.bars[1].now>=2) addXP(120);

  if(!state.byDate[currentDate]) state.byDate[currentDate]={dailyDone:{},dailyXP:0,validated:false};
  state.byDate[currentDate].validated=true;
  const dv=$("#date_validated"); if(dv) dv.textContent="oui";
  save(); toast("Journée validée ✅",'success');
});

/* ====== Rewards ====== */
function renderRewards(){
  const wrap=$("#rewards_list"), log=$("#rewards_log"); wrap.innerHTML="";
  state.rewards.catalog.forEach(it=>{
    const card=document.createElement("div"); card.className="card half";
    const blocked = it.blocked || !canUseReward(it);
    card.innerHTML = `
      <div class="row">
        <div><h3 style="margin:.2rem 0">${it.name}</h3><div class="muted">${it.tag}${blocked?' - BLOQUÉ':''}</div></div>
        <b>${it.cost} XP</b>
      </div>
      <button data-redeem="${it.id}" ${blocked?'disabled style="opacity:.5"':''}>${blocked?'Bloqué':`Utiliser ${it.cost} XP`}</button>`;
    wrap.appendChild(card);
  });
  wrap.onclick=(e)=>{
    const btn=e.target.closest("[data-redeem]"); if(!btn||btn.disabled) return;
    const it=state.rewards.catalog.find(x=>x.id===btn.dataset.redeem); if(!it) return;
    if((state.profile.xp||0)<it.cost) return toast("Pas assez d'XP.",'error');
    if(!canUseReward(it)) return toast("Récompense bloquée par les malus.",'error');
    state.profile.xp-=it.cost;
    state.rewards.log.unshift(`🎁 ${it.name} (${it.cost} XP) — ${new Date().toLocaleString()}`);
    save(); updateXP(); renderRewards(); toast("Profite bien ! 🎉",'success');
  };
  log.innerHTML = state.rewards.log.slice(0,10).map(x=>`<li>${x}</li>`).join("");
}
function canUseReward(reward){
  const a=state.malus.active;
  if(a.includes('no_rewards_daily')) return false;
  if(a.includes('no_rewards_weekend') && (reward.id==='weekend'||reward.id==='day_off')) return false;
  if(a.includes('no_shopping') && reward.id==='shopping') return false;
  if(a.includes('no_social') && reward.id==='friends') return false;
  if(a.includes('no_pleasure') && (reward.id==='activity'||reward.id==='day_off')) return false;
  return true;
}

/* ====== Malus ====== */
function renderMalus(){
  const c=$("#malus_status"); const active=state.malus.active, pen=state.malus.penalties;
  let html=`<h3>Règles de malus</h3>
  <div class="malus-item"><strong>Malus globaux :</strong><ul>
    <li>&lt;100 XP/jour → pas de récompense ce jour-là</li>
    <li>&lt;250 XP/semaine → pas de récompense le week-end</li>
    <li>&lt;200 XP/mois → défi exceptionnel</li></ul></div>
  <h3>Malus actifs (${active.length})</h3>`;
  if(active.length===0) html+=`<p class="muted">Aucun malus actif - Continue comme ça ! 🎉</p>`;
  else active.forEach(m=>html+=`<div class="malus-item malus-active">${getMalusDescription(m)}</div>`);
  html+=`<h3>Pénalités en cours (${pen.length})</h3>`;
  if(pen.length===0) html+=`<p class="muted">Aucune pénalité active</p>`;
  else pen.forEach(p=>html+=`<div class="malus-item">${p}</div>`);
  c.innerHTML=html;
}
function getMalusDescription(m){
  const d={
    'no_rewards_daily':"🚫 Pas de récompense aujourd'hui (<100 XP)",
    'no_rewards_weekend':"🚫 Pas de récompense week-end (<250 XP/semaine)",
    'no_shopping':"🚫 Pas de shopping (<100 XP business/semaine)",
    'no_social':"🚫 Pas de soirée amis (<3 lectures/semaine)",
    'no_pleasure':"🚫 Pas d'activité plaisir (<3 workouts/semaine)",
    'extra_prospects_mlm':"📈 +50 prospections MLM obligatoires",
    'extra_calls':"📞 +5 appels obligatoires",
    'extra_prospects_ugc':"📈 +30 prospections UGC obligatoires",
    'extra_workout':"🏋️ Workout extra week-end",
    'long_cardio':"🏃 Cardio long (45min) obligatoire",
    'sunday_reading':"📚 1h lecture dimanche obligatoire",
    'quran_reading':"📖 1h lecture coranique obligatoire"
  }; return d[m]||m;
}
$("#checkMalus").addEventListener("click",checkAndApplyMalus);
$("#applyMalus").addEventListener("click",checkAndApplyMalus);
function checkAndApplyMalus(){
  const newM=[], newP=[];
  if(state.profile.stats.dailyXP<100) newM.push('no_rewards_daily');
  if(state.profile.stats.weeklyXP<250) newM.push('no_rewards_weekend');
  const bizXP=calculateCategoryXP('business'); if(bizXP<100) newM.push('no_shopping');
  if(state.goals.business.bars[2].now===0){ newP.push('+50 prospections MLM obligatoires','+5 appels téléphoniques obligatoires'); }
  if(state.goals.ugc.bars[1].now===0) newP.push('+30 prospections UGC obligatoires');
  if(state.goals.sport.bars[0].now<3) newP.push('Workout extra le week-end');
  if(state.goals.sport.bars[1].now===0) newP.push('Cardio long (45min) la semaine suivante');
  if(state.goals.dev.bars[0].now<3){ newM.push('no_social'); newP.push('1h lecture le dimanche'); }
  const missed=7 - state.goals.spirituality.bars[0].now; if(missed>0) newM.push('no_rewards_daily');
  if(state.goals.spirituality.bars[1].now===0) newP.push('Lecture coranique (1h) le week-end');
  state.malus.active=newM; state.malus.penalties=newP; save(); renderMalus(); renderRewards(); updateStreaks();
  toast( (newM.length||newP.length)? `⚠️ ${newM.length} malus / ${newP.length} pénalités` : '✅ Aucun malus','warning');
}
function calculateCategoryXP(cat){
  let xp=0; ['daily','weekly','monthly'].forEach(s=>state.tasks[s].forEach(t=>{ if(t.category===cat && t.done) xp+=t.xp; })); return xp;
}

/* ====== Stats ====== */
function renderStats(){
  const c=$("#stats_content"), s=state.profile.stats;
  let html=`<div class="stats-grid">
    <div class="stat-card"><h3>XP Journalier</h3><div style="font-size:2rem">${s.dailyXP}</div></div>
    <div class="stat-card"><h3>XP Hebdomadaire</h3><div style="font-size:2rem">${s.weeklyXP}</div></div>
    <div class="stat-card"><h3>XP Mensuel</h3><div style="font-size:2rem">${s.monthlyXP}</div></div>
    <div class="stat-card"><h3>Niveau</h3><div style="font-size:2rem">${state.profile.level}</div></div>
  </div><h3>Progression par catégorie</h3>`;
  for(const cat of Object.values(state.goals)){
    html+=`<div class="card" style="margin-bottom:12px"><h4>${cat.label}</h4>`;
    cat.bars.forEach(b=>{
      const p=pct(b.now,b.goal);
      html+=`<div class="row" style="margin-bottom:8px"><span>${b.label}</span><span>${b.now}/${b.goal} (${p}%)</span></div><div class="bar"><span style="width:${p}%"></span></div>`;
    });
    html+=`</div>`;
  }
  c.innerHTML=html;
}

/* ====== Export / Import / Reset ====== */
$("#exportData").addEventListener("click",()=>{
  const dataStr=JSON.stringify(state,null,2);
  const blob=new Blob([dataStr],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`gamelife-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast("Données exportées ✅",'success');
});
$("#importData").addEventListener("click",()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(confirm("Remplacer toutes vos données ?")){ state=data; save(); init(); toast("Import ok ✅",'success'); }
      }catch(err){ toast("Fichier invalide",'error'); }
    }; r.readAsText(f);
  }; input.click();
});
$("#resetAll").addEventListener("click",()=>{ if(!confirm("Tout remettre à zéro ?"))return; state=dflt(); save(); init(); toast("Réinitialisé",'info'); });

/* ====== Manage modals (Tasks / Rewards) ====== */
let currentEditType=null, currentEditId=null;

$("#manageDailyTasks").addEventListener("click",()=>openTaskManager('daily'));
$("#manageWeeklyTasks").addEventListener("click",()=>openTaskManager('weekly'));
$("#manageMonthlyTasks").addEventListener("click",()=>openTaskManager('monthly'));

function openTaskManager(type){
  currentEditType=type;
  $("#taskModalTitle").textContent=`Gérer les tâches ${type==='daily'?'quotidiennes':type==='weekly'?'hebdomadaires':'mensuelles'}`;
  renderTaskManager(type);
  $("#taskModal").classList.add("active");
}
function renderTaskManager(type){
  const list=$("#taskManageList"); const tasks=state.tasks[type];
  list.innerHTML=tasks.map(t=>`
    <div class="manage-item">
      <div><strong>${t.label}</strong><div class="muted">${t.xp} XP - ${t.category}</div></div>
      <div class="manage-item-actions">
        <button onclick="editTask('${type}','${t.id}')">✏️</button>
        <button onclick="deleteTask('${type}','${t.id}')" class="danger">🗑️</button>
      </div>
    </div>`).join('');
}
window.editTask=function(type,id){
  const task=state.tasks[type].find(t=>t.id===id); if(!task) return;
  $("#editModalTitle").textContent="Modifier la tâche";
  $("#editName").value=task.label; $("#editValue").value=task.xp; $("#editCategory").value=task.category;
  $("#editCategoryGroup").style.display="block"; $("#editTagGroup").style.display="none";
  currentEditType=type; currentEditId=id; $("#editModal").classList.add("active");
}
window.deleteTask=function(type,id){
  if(!confirm("Supprimer cette tâche ?"))return;
  state.tasks[type]=state.tasks[type].filter(t=>t.id!==id); save(); renderTaskManager(type); renderTasks(); toast("Tâche supprimée",'info');
}
$("#addNewTask").addEventListener("click",()=>{
  $("#editModalTitle").textContent="Ajouter une tâche"; $("#editName").value=""; $("#editValue").value=10; $("#editCategory").value="discipline";
  $("#editCategoryGroup").style.display="block"; $("#editTagGroup").style.display="none"; currentEditId=null; $("#editModal").classList.add("active");
});

$("#manageRewards").addEventListener("click",()=>{ renderRewardManager(); $("#rewardModal").classList.add("active"); });
function renderRewardManager(){
  const list=$("#rewardManageList"), R=state.rewards.catalog;
  list.innerHTML=R.map(r=>`
    <div class="manage-item">
      <div><strong>${r.name}</strong><div class="muted">${r.cost} XP - ${r.tag}</div></div>
      <div class="manage-item-actions">
        <button onclick="editReward('${r.id}')">✏️</button>
        <button onclick="deleteReward('${r.id}')" class="danger">🗑️</button>
      </div>
    </div>`).join('');
}
window.editReward=function(id){
  const r=state.rewards.catalog.find(x=>x.id===id); if(!r) return;
  $("#editModalTitle").textContent="Modifier la récompense";
  $("#editName").value=r.name; $("#editValue").value=r.cost; $("#editTag").value=r.tag;
  $("#editCategoryGroup").style.display="none"; $("#editTagGroup").style.display="block";
  currentEditType='reward'; currentEditId=id; $("#editModal").classList.add("active");
}
window.deleteReward=function(id){
  if(!confirm("Supprimer cette récompense ?"))return;
  state.rewards.catalog=state.rewards.catalog.filter(r=>r.id!==id); save(); renderRewardManager(); renderRewards(); toast("Récompense supprimée",'info');
}
$("#addNewReward").addEventListener("click",()=>{
  $("#editModalTitle").textContent="Ajouter une récompense"; $("#editName").value=""; $("#editValue").value=100; $("#editTag").value="Détente";
  $("#editCategoryGroup").style.display="none"; $("#editTagGroup").style.display="block"; currentEditType='reward'; currentEditId=null; $("#editModal").classList.add("active");
});

/* Form edit (tasks/rewards) */
$("#editForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const name=$("#editName").value.trim(), val=parseInt($("#editValue").value);
  if(!name || !val) return;
  if(currentEditType==='reward'){
    const tag=$("#editTag").value.trim();
    if(currentEditId){ const r=state.rewards.catalog.find(x=>x.id===currentEditId); if(r){ r.name=name;r.cost=val;r.tag=tag; } }
    else{ state.rewards.catalog.push({id:'reward_'+Date.now(),name:name,cost:val,tag:tag,blocked:false}); }
    renderRewardManager(); renderRewards();
  }else{
    const cat=$("#editCategory").value;
    if(currentEditId){ const t=state.tasks[currentEditType].find(x=>x.id===currentEditId); if(t){ t.label=name;t.xp=val;t.category=cat; } }
    else{ state.tasks[currentEditType].push({id:'task_'+Date.now(),label:name,xp:val,category:cat,done:false}); }
    renderTaskManager(currentEditType); renderTasks();
  }
  save(); $("#editModal").classList.remove("active"); toast("Modifications sauvegardées",'success');
});

/* Close modals */
['closeTaskModal','closeRewardModal','cancelEdit'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.onclick=()=>{ document.getElementById('taskModal').classList.remove('active'); document.getElementById('rewardModal').classList.remove('active'); document.getElementById('editModal').classList.remove('active'); };
});
["taskModal","rewardModal","editModal"].forEach(mid=>{
  const m=document.getElementById(mid);
  m.addEventListener("click",(e)=>{ if(e.target.classList.contains("modal")) m.classList.remove("active"); });
});

/* ====== Name / Date storage ====== */
function todayISO(d=new Date()){ return d.toISOString().slice(0,10); }
let currentDate = todayISO();

function loadDay(date){
  const day = state.byDate[date] || {dailyDone:{},dailyXP:0,validated:false};
  state.tasks.daily.forEach(t=>{ t.done = !!day.dailyDone[t.id]; });
  renderTasks();
  const v=$("#date_validated"); if(v) v.textContent = day.validated ? "oui":"non";
}
function saveDay(date){
  const day = state.byDate[date] || {dailyDone:{},dailyXP:0,validated:false};
  state.tasks.daily.forEach(t=>{ day.dailyDone[t.id]=!!t.done; });
  day.dailyXP = state.tasks.daily.filter(t=>t.done).reduce((s,t)=>s+t.xp,0);
  state.byDate[date]=day; save();
}
$("#saveName").addEventListener("click",()=>{
  const name = ($("#player_name").value||"").trim();
  state.profile.name=name; save();
  $("#player_title_name").textContent = name? `🎮 ${name}` : "🎮 Joueur";
  toast("Pseudo enregistré",'success');
});
$("#player_name").addEventListener("input",()=>markDirty());
const dEl=$("#selected_date");
if(dEl){
  dEl.value=currentDate;
  dEl.onchange=(e)=>{ currentDate=e.target.value||todayISO(); loadDay(currentDate); };
}

/* ====== Auto-hide navbar ====== */
let lastScrollY=0,ticking=false;
function updateNavbar(){
  const y=window.scrollY, nav=$(".top");
  if(y>lastScrollY && y>100) nav.classList.add("hidden"); else nav.classList.remove("hidden");
  lastScrollY=y; ticking=false;
}
window.addEventListener("scroll",()=>{ if(!ticking){ requestAnimationFrame(updateNavbar); ticking=true; }});

/* ====== INIT ====== */
function init(){
  // migrations légères
  if(!state.profile) state.profile={level:1,xp:0,name:"",streaks:{prayer:0},stats:{dailyXP:0,weeklyXP:0,monthlyXP:0}};
  if(!state.money) state.money={week:{goal:0,done:0},month:{goal:0,done:0}};

  $("#player_name").value = state.profile.name||"";
  $("#player_title_name").textContent = state.profile.name? `🎮 ${state.profile.name}` : "🎮 Joueur";

  renderKPIs();
  renderSectorGauges();
  renderTasks();
  renderRewards();
  renderMalus();
  renderStats();
  renderMoney();
  updateXP();
  updateStreaks();
  loadDay(currentDate);
  markDirty(false);
}
init();
</script>
</body>
</html>
